<!--
APP: Anchor
FILE: app/index.html
VERSION: v0.3.2
DATE(JST): 2026-01-06 11:18 JST
TITLE: ã€ŒYuiæŒ‡ç¤ºï¼ˆA/B/Cï¼‰â†’è³ªå•â†’ä»¥é™ã‚’å‡ºã—ç›´ã—ã€ï¼‹1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é€²è¡Œï¼‹ç”¨èªãƒˆãƒ¼ã‚¹ãƒˆè§£èª¬
CHANGES:
- Roomã¨ã¯åˆ¥ã«ã€ŒGuidanceï¼ˆæŒ‡ç¤ºï¼‰ã€ã‚’ãƒ«ãƒ¼ãƒ ã«ç´ã¥ã‘ã¦ä¿å­˜ï¼ˆA/B/Cãªã©ã®æ‰‹é †ã‚«ãƒ¼ãƒ‰ï¼‰
- å„æ‰‹é †ã‚«ãƒ¼ãƒ‰ã«ã€Œè³ªå•ã€ãƒœã‚¿ãƒ³ï¼šè³ªå•ã™ã‚‹ã¨â€œãã‚Œä»¥é™ã®æŒ‡ç¤ºâ€ã‚’ä¸€æ—¦ãŸãŸã¿ã€å›ç­”æ¬„â†’ç¶šãï¼ˆå†ä½œæˆï¼‰ã‚’åŒã˜æµã‚Œã§ç®¡ç†
- 1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ï¼šæ¬¡ã®1ã¤ã ã‘ã‚’å¤§ããè¡¨ç¤ºã—ã€Œå®Œäº†ã€ã§æ¬¡ã¸é€²ã‚€ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰
- å°‚é–€ç”¨èªï¼šæŒ‡ç¤ºæ–‡å†…ã®æ–‡å­—ã‚’ç¯„å›²é¸æŠâ†’ãƒˆãƒ¼ã‚¹ãƒˆã§ç”¨èªèª¬æ˜ï¼ˆè¾æ›¸ç™»éŒ²ï¼‰ï¼ã€Œè©³ã—ãã€ã§åˆ¥ç”»é¢ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰èª¬æ˜
NOTE:
- ã„ã¾ã¯â€œåœŸå°ï¼ˆUI/ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼‰â€ã¾ã§ã€‚AIå›ç­”ã¯å¾Œã§æ¥ç¶šï¼ˆAPIï¼‰äºˆå®šã€‚ç¾çŠ¶ã¯ã€Œå›ç­”æ¬„ã«è²¼ã‚‹ã€é‹ç”¨ã§å‹•ãã€‚
AUTHOR: Yui
BUILD_PARAM: ?b=2026-01-06_1118_anchor-icon-font-v032
DEBUG_PARAM: &debug=1
POLICY: UIã‚’å¢—ã‚„ã—ã™ããšã€è¿·å­ã«ãªã‚‰ãªã„â€œä¼šè©±ã®æµã‚Œâ€ã‚’æœ€å„ªå…ˆã€‚
-->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Anchor</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22256%22%20height%3D%22256%22%20viewBox%3D%220%200%20256%20256%22%3E%0A%3Cdefs%3E%0A%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%20r%3D%2280%25%22%3E%0A%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23b9d4ff%22/%3E%0A%20%20%20%20%3Cstop%20offset%3D%2255%25%22%20stop-color%3D%22%236ea8ff%22/%3E%0A%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%231e3a8a%22/%3E%0A%20%20%3C/radialGradient%3E%0A%3C/defs%3E%0A%3Crect%20x%3D%2216%22%20y%3D%2216%22%20width%3D%22224%22%20height%3D%22224%22%20rx%3D%2256%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.10%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.18%29%22%20stroke-width%3D%226%22/%3E%0A%3Ccircle%20cx%3D%22128%22%20cy%3D%22122%22%20r%3D%2262%22%20fill%3D%22url%28%23g%29%22%20opacity%3D%220.55%22/%3E%0A%3Cpath%20d%3D%22M128%2054%20v98%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.86%29%22%20stroke-width%3D%2212%22%20stroke-linecap%3D%22round%22/%3E%0A%3Ccircle%20cx%3D%22128%22%20cy%3D%2254%22%20r%3D%2214%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.86%29%22/%3E%0A%3Cpath%20d%3D%22M86%20120%0A%20%20c%200%2048%2022%2072%2042%2078%0A%20%20c%20-20%20-6%20-42%20-30%20-42%20-78%0A%20%20M170%20120%0A%20%20c%200%2048%20-22%2072%20-42%2078%0A%20%20c%2020%20-6%2042%20-30%2042%20-78%22%20fill%3D%22none%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.86%29%22%20stroke-width%3D%2212%22%20stroke-linecap%3D%22round%22/%3E%0A%3Cpath%20d%3D%22M86%20120%0A%20%20c%200%2058%2040%2092%2084%2092%0A%20%20c%2044%200%2084%20-34%2084%20-92%22%20fill%3D%22none%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.38%29%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22256%22%20height%3D%22256%22%20viewBox%3D%220%200%20256%20256%22%3E%0A%3Cdefs%3E%0A%20%20%3CradialGradient%20id%3D%22g%22%20cx%3D%2230%25%22%20cy%3D%2230%25%22%20r%3D%2280%25%22%3E%0A%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%23b9d4ff%22/%3E%0A%20%20%20%20%3Cstop%20offset%3D%2255%25%22%20stop-color%3D%22%236ea8ff%22/%3E%0A%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%231e3a8a%22/%3E%0A%20%20%3C/radialGradient%3E%0A%3C/defs%3E%0A%3Crect%20x%3D%2216%22%20y%3D%2216%22%20width%3D%22224%22%20height%3D%22224%22%20rx%3D%2256%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.10%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.18%29%22%20stroke-width%3D%226%22/%3E%0A%3Ccircle%20cx%3D%22128%22%20cy%3D%22122%22%20r%3D%2262%22%20fill%3D%22url%28%23g%29%22%20opacity%3D%220.55%22/%3E%0A%3Cpath%20d%3D%22M128%2054%20v98%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.86%29%22%20stroke-width%3D%2212%22%20stroke-linecap%3D%22round%22/%3E%0A%3Ccircle%20cx%3D%22128%22%20cy%3D%2254%22%20r%3D%2214%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.86%29%22/%3E%0A%3Cpath%20d%3D%22M86%20120%0A%20%20c%200%2048%2022%2072%2042%2078%0A%20%20c%20-20%20-6%20-42%20-30%20-42%20-78%0A%20%20M170%20120%0A%20%20c%200%2048%20-22%2072%20-42%2078%0A%20%20c%2020%20-6%2042%20-30%2042%20-78%22%20fill%3D%22none%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.86%29%22%20stroke-width%3D%2212%22%20stroke-linecap%3D%22round%22/%3E%0A%3Cpath%20d%3D%22M86%20120%0A%20%20c%200%2058%2040%2092%2084%2092%0A%20%20c%2044%200%2084%20-34%2084%20-92%22%20fill%3D%22none%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.38%29%22%20stroke-width%3D%2210%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E">

  <style>
    :root{
      --bg0:#0b1220; --bg1:#0f1d33; --bg2:#070b14;
      --card: rgba(255,255,255,0.06);
      --line: rgba(255,255,255,0.10);
      --txt: rgba(255,255,255,0.92);
      --sub: rgba(255,255,255,0.72);
      --mut: rgba(255,255,255,0.55);
      --acc:#8ab4ff;
      --ok:#48d17a;
      --warn:#ffce66;
      --bad:#ff6b6b;
      --shadow: 0 18px 50px rgba(0,0,0,0.40);
      --r2: 20px;
      --ui-scale: 1.0;
      --font: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic UI", "Yu Gothic", Meiryo, sans-serif;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(138,180,255,0.22), transparent 55%),
        radial-gradient(900px 500px at 70% 15%, rgba(72,209,122,0.14), transparent 55%),
        radial-gradient(1200px 800px at 50% 80%, rgba(255,255,255,0.06), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2) 60%, var(--bg0));
      overflow:hidden;
    }
    .wrap{ max-width: 1260px; margin: 0 auto; padding: 18px 14px; height:100%; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.10);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .icon{ width:34px;height:34px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.25), rgba(255,255,255,0.08));
      border:1px solid rgba(255,255,255,0.14);
      box-shadow: 0 8px 22px rgba(0,0,0,0.35);
      position:relative; flex:0 0 auto;
    }
    .icon:after{ content:""; position:absolute; inset:8px; border-radius:10px;
      background: radial-gradient(circle at 30% 30%, rgba(138,180,255,0.85), rgba(138,180,255,0.20));
      opacity:0.65;
    }
    .brandTitle{ font-weight: 800; letter-spacing: 0.2px; font-size: calc(15px * var(--ui-scale)); }
    .brandSub{ font-size: calc(12px * var(--ui-scale)); color: var(--sub); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:56vw; }
    .mono{ font-family:var(--mono); }

    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding: 9px 11px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: var(--txt);
      font-size: calc(13px * var(--ui-scale)); font-weight: 650;
      cursor: pointer; user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.10); }
    .btn.primary{ background: rgba(138,180,255,0.18); border-color: rgba(138,180,255,0.25); }
    .btn.ghost{ background: rgba(0,0,0,0.08); color: var(--sub); font-weight: 600; }
    .btn.danger{ background: rgba(255,107,107,0.12); border-color: rgba(255,107,107,0.22); }
    .btn.small{ padding: 6px 9px; border-radius: 11px; font-size: calc(12px * var(--ui-scale)); font-weight: 650; }

    .main{
      margin-top: 12px;
      height: calc(100% - 74px);
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .main{ grid-template-columns: 1fr; grid-template-rows: 290px 1fr; height: calc(100% - 86px); }
    }

    .panel{
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .panelHead{ padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.10); }
    .panelTitle{ font-weight: 800; font-size: calc(13px * var(--ui-scale)); color: rgba(255,255,255,0.86); }
    .panelSub{ margin-top:6px; font-size: calc(12px * var(--ui-scale)); color: var(--mut); line-height:1.45; }
    .panelBody{ padding: 10px 12px 12px; overflow:auto; min-height: 0; }

    .row{ display:flex; gap:8px; align-items:center; }
    .grow{ flex:1 1 auto; min-width:0; }
    .select,.input,textarea.msg{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.10);
      color: var(--txt);
      outline:none;
      font-family: var(--font);
    }
    textarea.msg{ min-height: 46px; max-height: 180px; resize: vertical; }
    .roomList{ display:flex; flex-direction:column; gap:8px; }
    .roomItem{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
    }
    .roomItem:hover{ background: rgba(255,255,255,0.06); }
    .roomItem.active{ background: rgba(138,180,255,0.12); border-color: rgba(138,180,255,0.25); }
    .roomName{ font-weight: 750; font-size: calc(13px * var(--ui-scale)); }
    .roomMeta{ font-size: calc(11.5px * var(--ui-scale)); color: var(--mut); margin-top:6px; line-height:1.35; }

    .chatHead{ padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.10); }
    .chatTitle{ margin:0; font-size: calc(14px * var(--ui-scale)); font-weight: 900; }
    .chatSub{ margin-top:6px; color: var(--mut); font-size: calc(12px * var(--ui-scale)); line-height:1.45; }

    .tabs{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .tab{ padding: 6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.10); color: var(--sub); font-size:12px; cursor:pointer; user-select:none; }
    .tab.active{ background: rgba(138,180,255,0.16); border-color: rgba(138,180,255,0.28); color: rgba(255,255,255,0.88); }

    .chatBody{ padding: 10px 12px; overflow:auto; min-height:0; flex:1 1 auto; }
    .bubble{ max-width: 92%; border-radius: 16px; border:1px solid rgba(255,255,255,0.10); padding: 10px 12px; margin: 8px 0; background: rgba(0,0,0,0.10); }
    .bubble.me{ margin-left:auto; background: rgba(138,180,255,0.10); border-color: rgba(138,180,255,0.22); }
    .bMeta{ display:flex; justify-content:space-between; margin-bottom:6px; gap:10px; }
    .who{ font-size: calc(11px * var(--ui-scale)); color: var(--mut); }
    .time{ font-size: calc(11px * var(--ui-scale)); color: rgba(255,255,255,0.42); font-family: var(--mono); }
    .bText{ font-size: calc(13px * var(--ui-scale)); line-height:1.55; white-space:pre-wrap; word-break:break-word; }

    .composer{ padding: 10px 12px 12px; border-top: 1px solid rgba(255,255,255,0.10); background: rgba(0,0,0,0.06); }
    .sendRow{ display:flex; gap:10px; align-items:flex-end; }
    .hint{ margin-top:8px; font-size: calc(12px * var(--ui-scale)); color: var(--mut); line-height:1.45; }

    /* Guidance */
    .gWrap{ display:flex; flex-direction:column; gap:10px; }
    .gTop{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:space-between; }
    .gCard{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.10);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .gHead{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; }
    .gLabel{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .gTag{ font-size: calc(11px * var(--ui-scale)); padding: 4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); color: var(--mut); white-space:nowrap; }
    .gTag.step{ border-color: rgba(138,180,255,0.22); background: rgba(138,180,255,0.10); color: rgba(220,235,255,0.95); }
    .gTag.arch{ border-color: rgba(255,206,102,0.22); background: rgba(255,206,102,0.10); color: rgba(255,236,190,0.95); }
    .gTitle{ font-weight: 850; font-size: calc(13px * var(--ui-scale)); }
    .gText{ margin-top:8px; font-size: calc(13px * var(--ui-scale)); line-height:1.6; color: rgba(255,255,255,0.88); white-space:pre-wrap; word-break:break-word; }
    .gBtns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .gAnswer{ margin-top:10px; border-top: 1px solid rgba(255,255,255,0.10); padding-top:10px; }
    .gAnswer .ttl{ font-size: calc(12px * var(--ui-scale)); color: var(--mut); margin-bottom:6px; }
    .smallstep{ border: 1px solid rgba(138,180,255,0.25); background: rgba(138,180,255,0.08); }

    .overlay{ position: fixed; inset:0; background: rgba(0,0,0,0.55); display:none; align-items:center; justify-content:center; padding: 18px; z-index: 50; }
    .overlay.show{ display:flex; }
    .modal{ width: min(900px, 100%); border-radius: 18px; border: 1px solid rgba(255,255,255,0.14); background: rgba(12,18,32,0.92); box-shadow: 0 25px 80px rgba(0,0,0,0.55); backdrop-filter: blur(12px); overflow:hidden; }
    .modalHead{ display:flex; align-items:center; justify-content:space-between; padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.10); gap:10px; }
    .modalHead .t{ font-weight: 900; }
    .x{ width:34px;height:34px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06); display:grid; place-items:center; cursor:pointer; user-select:none; }
    .modalBody{ padding: 14px 16px 16px; }
    label{ display:block; color: var(--mut); font-size: calc(12px * var(--ui-scale)); margin: 10px 0 6px; }
    .modalBtns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top: 12px; }

    .toast{
      position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%);
      max-width: min(860px, calc(100% - 24px));
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.62);
      color: rgba(255,255,255,0.86);
      font-size: calc(12px * var(--ui-scale));
      box-shadow: 0 14px 60px rgba(0,0,0,0.55);
      backdrop-filter: blur(10px);
      display:none;
      z-index: 60;
    }
    .toast.show{ display:block; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="icon" aria-hidden="true"></div>
        <div>
          <div class="brandTitle">Anchor</div>
          <div class="brandSub">Roomï¼ˆä¼šè©±ï¼‰ï¼‹ Guidanceï¼ˆæŒ‡ç¤ºï¼‰ã§ã€è³ªå•â†’ç¶šãå‡ºã—ç›´ã—ã®æµã‚Œã‚’ä½œã‚‹ã€‚</div>
        </div>
      </div>
      <div class="row" style="gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <div class="btn ghost" style="cursor:default;">
          <span style="width:8px;height:8px;border-radius:50%;background:var(--ok);display:inline-block;box-shadow:0 0 0 3px rgba(72,209,122,0.15);"></span>
          <span class="mono">v0.3.1</span> <span class="mono" style="opacity:.65">|</span> <span class="mono">2026-01-06_1118_anchor-icon-font-v032</span>
        </div>
        
        <button class="btn ghost" id="btnFontS" type="button">æ–‡å­— å°</button>
        <button class="btn ghost" id="btnFontM" type="button">æ–‡å­— ä¸­</button>
        <button class="btn ghost" id="btnFontL" type="button">æ–‡å­— å¤§</button>
<button class="btn ghost" id="btnExport" type="button">â¤“ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button class="btn ghost" id="btnImport" type="button">â¤’ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      </div>
    </div>

    <div class="main">
      <!-- Left -->
      <section class="panel" aria-label="Projects and Rooms">
        <div class="panelHead">
          <div class="panelTitle">Projectï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰ / Roomï¼ˆä¼šè©±ï¼‰</div>
          <div class="panelSub">å‘¼ã³åã¯ <strong>Room</strong> ãŒã„ã¡ã°ã‚“è‡ªç„¶ã€‚æ¬¡ç‚¹ï¼šThreadï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ï¼‰/ Chatï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ã€‚</div>
        </div>
        <div class="panelBody">
          <div class="row">
            <div class="grow"><select class="select" id="selProject" aria-label="Project"></select></div>
            <button class="btn" id="btnNewProject" type="button">ï¼‹</button>
          </div>

          <div style="height:10px;"></div>

          <div class="row">
            <div class="grow"><input class="input" id="inRoomSearch" placeholder="ãƒ«ãƒ¼ãƒ æ¤œç´¢ï¼ˆã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰" /></div>
            <button class="btn" id="btnNewRoom" type="button">ï¼‹Room</button>
          </div>

          <div style="height:10px;"></div>
          <div class="roomList" id="roomList"></div>
        </div>
      </section>

      <!-- Right -->
      <section class="panel" aria-label="Room">
        <div class="chatHead">
          <h2 class="chatTitle" id="chatTitle">Room</h2>
          <div class="chatSub" id="chatSub">Guidanceï¼ˆæŒ‡ç¤ºï¼‰ã¨Chatï¼ˆä¼šè©±ï¼‰ã‚’åŒã˜Roomã«ã¾ã¨ã‚ã¾ã™ã€‚</div>

          <div class="tabs" role="tablist" aria-label="View Tabs">
            <div class="tab active" id="tabGuidance" role="tab" aria-selected="true">Guidanceï¼ˆæŒ‡ç¤ºï¼‰</div>
            <div class="tab" id="tabChat" role="tab" aria-selected="false">Chatï¼ˆä¼šè©±ãƒ­ã‚°ï¼‰</div>
          </div>

          <div class="row" style="margin-top:10px; flex-wrap:wrap;">
            <button class="btn ghost" id="btnRoomRename" type="button">âœ åå‰</button>
            <button class="btn ghost" id="btnRoomPin" type="button">ğŸ“Œ ãƒ”ãƒ³</button>
            <button class="btn ghost" id="btnRoomClone" type="button">â˜ è¤‡è£½</button>
            <button class="btn danger" id="btnRoomDelete" type="button">ğŸ—‘ å‰Šé™¤</button>
          </div>
        </div>

        <div class="chatBody" id="rightBody"></div>

        <div class="composer">
          <div class="sendRow">
            <div class="grow"><textarea class="msg" id="taMsg" placeholder="ï¼ˆChatç”¨ï¼‰ã“ã“ã«å…¥åŠ›ï¼šShift+Enterã§æ”¹è¡Œ / Enterã§é€ä¿¡"></textarea></div>
            <button class="btn primary" id="btnSend" type="button">é€ä¿¡</button>
          </div>
          <div class="hint">
            <strong>Guidanceã®ã‚³ãƒ„ï¼š</strong> A/B/C ã®ã€Œæ‰‹é †ã‚«ãƒ¼ãƒ‰ã€ã‚’ç½®ã„ã¦ã€åˆ†ã‹ã‚‰ãªã„ã¨ã“ã‚ã¯ â€œè³ªå•â€ â†’ å›ç­” â†’ ã¤ã¥ãï¼ˆå†ä½œæˆï¼‰ã§é€²ã‚ã‚‹ã€‚<br/>
            <strong>ç”¨èªï¼š</strong> æŒ‡ç¤ºæ–‡ã®æ–‡å­—ã‚’æŒ‡ã§é¸ã¶ï¼ˆç¯„å›²æŒ‡å®šï¼‰ã¨ãƒˆãƒ¼ã‚¹ãƒˆã§èª¬æ˜ãŒå‡ºã‚‹ã‚ˆã€‚
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <div class="t" id="modalTitle">ãƒ‡ãƒ¼ã‚¿</div>
        <div class="x" id="btnClose">âœ•</div>
      </div>
      <div class="modalBody">
        <div id="modalDesc" style="color: var(--mut); font-size:12px; line-height:1.5;"></div>

        <div id="modalModeExport" style="display:none;">
          <label for="taJson">JSONï¼ˆä¸¸ã”ã¨ï¼‰</label>
          <textarea class="msg" id="taJson" style="min-height: 280px; font-family: var(--mono);"></textarea>
          <div class="modalBtns">
            <button class="btn ghost" id="btnCopy" type="button">ã‚³ãƒ”ãƒ¼</button>
            <button class="btn primary" id="btnApply" type="button">OKï¼ˆé–‰ã˜ã‚‹ï¼‰</button>
          </div>
        </div>

        <div id="modalModeImport" style="display:none;">
          <label for="taJsonIn">JSONï¼ˆè²¼ã‚Šä»˜ã‘ï¼‰</label>
          <textarea class="msg" id="taJsonIn" style="min-height: 280px; font-family: var(--mono);"></textarea>
          <div class="modalBtns">
            <button class="btn ghost" id="btnPaste" type="button">è²¼ã‚Šä»˜ã‘</button>
            <button class="btn primary" id="btnApplyIn" type="button">åæ˜ ï¼ˆç½®ãæ›ãˆï¼‰</button>
          </div>
        </div>

        <div id="modalModeTerm" style="display:none;">
          <div style="border:1px solid rgba(255,255,255,0.10); border-radius:14px; padding:10px 10px; background: rgba(0,0,0,0.10);">
            <div style="font-size:12px; color: var(--mut);">é¸æŠã•ã‚ŒãŸç”¨èª</div>
            <div id="termWord" style="margin-top:6px; font-weight:900;"></div>
          </div>
          <div style="margin-top:10px; font-size:13px; line-height:1.6; color: rgba(255,255,255,0.88); white-space:pre-wrap;" id="termLong"></div>
          <div class="modalBtns">
            <button class="btn primary" id="btnTermClose" type="button">OK</button>
          </div>
        </div>

        <div style="margin-top:12px; color: rgba(255,255,255,0.42); font-size:11.5px; line-height:1.45;">
          â€» JSONã«ç§˜å¯†ï¼ˆAPIã‚­ãƒ¼ç­‰ï¼‰ã¯å…¥ã‚Œãªã„ã€‚<br/>
          â€» ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ã€Œç½®ãæ›ãˆã€æ–¹å¼ï¼ˆè¿·å­é˜²æ­¢ï¼‰ã€‚
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const APP_VERSION = "v0.3.2";
  const BUILD_ID = "2026-01-06_1118_anchor-icon-font-v032";
  const STORAGE_KEY = "anchor_db_v2";
  const UI_SCALE_KEY = "anchor_ui_scale_v1";
  const DEFAULT_ASSISTANT_NAME = "ãƒ¦ã‚¤";
  const DEFAULT_ASSISTANT_STYLE = "1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ»ã‚¹ãƒ¢ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåˆå¿ƒè€…å‘ã‘ï¼‰";

  const $ = (id) => document.getElementById(id);

  const elProject = $("selProject");
  const elRoomList = $("roomList");
  const elSearch = $("inRoomSearch");
  const elRightBody = $("rightBody");
  const elChatTitle = $("chatTitle");
  const elChatSub = $("chatSub");
  const elMsg = $("taMsg");

  const tabGuidance = $("tabGuidance");
  const tabChat = $("tabChat");

  const overlay = $("overlay");
  const modalTitle = $("modalTitle");
  const modalDesc = $("modalDesc");
  const modeExport = $("modalModeExport");
  const modeImport = $("modalModeImport");
  const modeTerm = $("modalModeTerm");
  const taJson = $("taJson");
  const taJsonIn = $("taJsonIn");
  const termWord = $("termWord");
  const termLong = $("termLong");

  const toastEl = $("toast");
  let toastTimer = null;

  // --- Term dictionary (short + long)
  const TERM = {
    "ãƒ–ãƒ©ãƒ³ãƒ": {
      short: "ã‚³ãƒ¼ãƒ‰ã®åˆ†å²ï¼ˆæœ¬ç•ªã‚’å£Šã•ãªã„ãŸã‚ã®â€œåˆ¥ç·šâ€ï¼‰",
      long: "ãƒ–ãƒ©ãƒ³ãƒï¼åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã®ä¸­ã§ã€ã‚³ãƒ¼ãƒ‰ã‚’â€œåˆ†å²â€ã•ã›ãŸé“ç­‹ã€‚\nmainï¼ˆæœ¬ç•ªï¼‰ã‚’å›ºå®šã—ã¦ã€stableï¼ˆä½œæ¥­ï¼‰ã§è©¦ã™â€¦ã®ã‚ˆã†ã«ä½¿ã†ã¨å®‰å…¨ã€‚"
    },
    "ãƒªãƒã‚¸ãƒˆãƒª": {
      short: "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å…¥ã‚Œç‰©ï¼ˆã‚³ãƒ¼ãƒ‰ç½®ãå ´ï¼‰",
      long: "ãƒªãƒã‚¸ãƒˆãƒªï¼GitHubä¸Šã®â€œç®±â€ã€‚\nã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆindex.htmlãªã©ï¼‰ã‚„å±¥æ­´ãŒå…¥ã‚‹ã€‚"
    },
    "Firebase Hosting": {
      short: "Webã‚µã‚¤ãƒˆã‚’å…¬é–‹ã™ã‚‹å ´æ‰€ï¼ˆFirebaseã®é…å¸ƒï¼‰",
      long: "Firebase Hostingï¼Firebaseã§é™çš„ã‚µã‚¤ãƒˆã‚’é…å¸ƒã™ã‚‹ä»•çµ„ã¿ã€‚\nURLï¼ˆ*.web.appï¼‰ã§å…¬é–‹ã§ãã€GitHub Actionsã§è‡ªå‹•é…å¸ƒã‚‚ã§ãã‚‹ã€‚"
    },
    "GitHub Actions": {
      short: "GitHubä¸Šã§è‡ªå‹•ä½œæ¥­ï¼ˆè‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ç­‰ï¼‰",
      long: "GitHub Actionsï¼GitHubã®è‡ªå‹•å®Ÿè¡Œæ©Ÿèƒ½ã€‚\nâ€œPushã—ãŸã‚‰è‡ªå‹•ã§Firebaseã¸é…å¸ƒâ€ãªã©ãŒã§ãã‚‹ã€‚"
    },
    "ãƒ‡ãƒ—ãƒ­ã‚¤": {
      short: "å…¬é–‹ã™ã‚‹ï¼ˆãƒãƒƒãƒˆã«åæ˜ ã™ã‚‹ï¼‰",
      long: "ãƒ‡ãƒ—ãƒ­ã‚¤ï¼æ›´æ–°ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¬é–‹å…ˆã¸åæ˜ ã™ã‚‹ã“ã¨ã€‚\nHostingã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€URLã§è¦‹ãˆã‚‹çŠ¶æ…‹ã«ã™ã‚‹ã€‚"
    },
    "ãƒˆãƒ¼ã‚¯ãƒ³": {
      short: "æœ¬äººç¢ºèªç”¨ã®é•·ã„æ–‡å­—åˆ—ï¼ˆéµï¼‰",
      long: "ãƒˆãƒ¼ã‚¯ãƒ³ï¼ãƒ­ã‚°ã‚¤ãƒ³ã‚„æ¨©é™ç¢ºèªã«ä½¿ã†â€œéµâ€ã€‚\nçµ¶å¯¾ã«ä»–äººã«è¦‹ã›ãªã„ã€‚ã‚¹ã‚¯ã‚·ãƒ§ã«ã‚‚å†™ã•ãªã„ã€‚"
    },
    "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ": {
      short: "è‡ªå‹•ä½œæ¥­ç”¨ã®â€œå°‚ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼â€",
      long: "ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼GitHub Actionsç­‰ã®è‡ªå‹•å‡¦ç†ãŒä½¿ã†â€œå°‚ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ©Ÿæ¢°ç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰â€ã€‚\néµï¼ˆJSONï¼‰ã§èªè¨¼ã™ã‚‹ã€‚"
    }
  };


  function applyUiScale(v){
    const n = Number(v);
    const val = (isFinite(n) && n>0.75 && n<1.6) ? n : 1.0;
    document.documentElement.style.setProperty("--ui-scale", String(val));
    try{ localStorage.setItem(UI_SCALE_KEY, String(val)); }catch(e){}
  }
  function loadUiScale(){
    try{
      const raw = localStorage.getItem(UI_SCALE_KEY);
      if(!raw) return 1.0;
      const n = Number(raw);
      if(isFinite(n)) return n;
      return 1.0;
    }catch(e){ return 1.0; }
  }

  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove("show"), 2300);
  }

  function nowIso() { return new Date().toISOString(); }

  function fmtTime(iso) {
    try {
      const d = new Date(iso);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return hh + ":" + mm + ":" + ss;
    } catch(e) { return ""; }
  }

  function uid(prefix="id") {
    return prefix + "_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
  }

  // Data model:
  // project -> rooms[] -> { messages[], guidance: { steps[], mode, cursor } }
  function defaultGuidance() {
    return {
      mode: "normal",        // normal / small
      cursor: 0,             // for small-step
      steps: [
        {
          id: uid("s"),
          label: "A",
          title: "é…å¸ƒæ–¹å¼ã‚’æ±ºã‚ã‚‹",
          text: "A) GitHub Pages / B) Firebase Hosting / C) GAS Webã‚¢ãƒ—ãƒª\nâ†’ ä»Šå›ã¯ Bï¼ˆFirebase Hostingï¼‰ã§é€²ã‚ã‚‹ã€‚",
          status: "active",    // active / archived
          qa: []               // [{q, a, ts}]
        },
        {
          id: uid("s"),
          label: "B",
          title: "Hosting ã‚’æœ‰åŠ¹åŒ–ã—ã¦å…¬é–‹ã™ã‚‹",
          text: "Firebase ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ Hosting ã‚’æœ‰åŠ¹åŒ– â†’ GitHub Actions ã§ deploy ã‚’å›ã™ã€‚",
          status: "active",
          qa: []
        },
        {
          id: uid("s"),
          label: "C",
          title: "å‹•ä½œç¢ºèªã¨æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³",
          text: "URLã§é–‹ã„ã¦è¡¨ç¤ºç¢ºèª â†’ ã†ã¾ãã„ã£ãŸã‚‰ stableâ†’main åæ˜ ã®é‹ç”¨ã«ä¹—ã›ã‚‹ã€‚",
          status: "active",
          qa: []
        }
      ]
    };
  }

  const DEFAULT_DB = {
    projects: [
      { id:"p_anchor", name:"Anchorï¼ˆæ”¯æ´ã‚¢ãƒ—ãƒªï¼‰", rooms:[
        {
          id:"r_today",
          name:"ä»Šæ—¥ã®ä½œæ¥­",
          pinned:true,
          updatedAt: nowIso(),
          messages: [
            { id: uid("m"), role:"you", text:"ã“ã“ã¯Roomã€‚Guidanceï¼ˆæŒ‡ç¤ºï¼‰ã¨Chatï¼ˆä¼šè©±ï¼‰ã‚’ä¸€ç·’ã«ç®¡ç†ã™ã‚‹ã‚ˆã€‚", ts: nowIso() },
            { id: uid("m"), role:"me", text:"äº†è§£ã€‚A/B/Cã®æŒ‡ç¤ºãŒæ¥ãŸã‚‰ã€åˆ†ã‹ã‚‰ãªã„æ‰€ã ã‘è³ªå•ã—ã¦å…ˆã«é€²ã¿ãŸã„ã€‚", ts: nowIso() }
          ],
          guidance: {
            mode: "small",
            cursor: 0,
            steps: [
              {
                id: uid("s"),
                label: "A",
                title: "Step 1ï¼šãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œã‚‹",
                text: "GitHub â†’ ï¼‹ â†’ New repository\nåå‰ï¼šwit-anchorï¼ˆä¾‹ï¼‰\nREADMEã«ãƒã‚§ãƒƒã‚¯ â†’ Create\nï¼ˆç”¨èªï¼šãƒªãƒã‚¸ãƒˆãƒªã€ãƒ–ãƒ©ãƒ³ãƒï¼‰",
                status: "active",
                qa: []
              },
              {
                id: uid("s"),
                label: "B",
                title: "Step 2ï¼šstableãƒ–ãƒ©ãƒ³ãƒã‚’ä½œã‚‹",
                text: "mainã‹ã‚‰stableã‚’ä½œã‚‹ã€‚å½¹å‰²å›ºå®šï¼šmain=æœ¬ç•ªã€stable=ä½œæ¥­ã€‚",
                status: "active",
                qa: []
              },
              {
                id: uid("s"),
                label: "C",
                title: "Step 3ï¼šæœ€åˆã®index.htmlã‚’ç½®ã",
                text: "app/index.html ã‚’é…ç½®ã—ã¦ã€Hostingã§å…¬é–‹ã€‚\nï¼ˆå¾Œã§ï¼šCommit stable â†’ Promote mainï¼‰",
                status: "active",
                qa: []
              }
            ]
          }
        }
      ]},
      { id:"p_smartprice", name:"Smart Price", rooms:[
        { id:"r_sync", name:"åŒæœŸã‚¨ãƒ©ãƒ¼èª¿æŸ»", pinned:false, updatedAt: nowIso(), messages:[], guidance: defaultGuidance() }
      ]},
      { id:"p_notelink", name:"NoteLink", rooms:[
        { id:"r_rules", name:"UIå›ºå®šãƒ«ãƒ¼ãƒ«", pinned:false, updatedAt: nowIso(), messages:[], guidance: defaultGuidance() }
      ]}
    ],
    active: { projectId:"p_anchor", roomId:"r_today" },
    ui: { rightTab: "guidance" },
    meta: { version: APP_VERSION, build: BUILD_ID, savedAt: nowIso() }
  };

  let db = null;

  function loadDb() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(DEFAULT_DB);
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return structuredClone(DEFAULT_DB);
      return obj;
    } catch(e) {
      return structuredClone(DEFAULT_DB);
    }
  }

  function saveDb() {
    db.meta = db.meta || {};
    db.meta.version = APP_VERSION;
    db.meta.build = BUILD_ID;
    db.meta.savedAt = nowIso();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }

  function getProject(pid) {
    return (db.projects || []).find(p => p.id === pid) || null;
  }
  function getRoom(pid, rid) {
    const p = getProject(pid);
    if(!p) return null;
    return (p.rooms || []).find(r => r.id === rid) || null;
  }

  function ensureActive() {
    if(!db.projects || db.projects.length === 0) db.projects = structuredClone(DEFAULT_DB.projects);
    if(!db.active) db.active = { projectId: db.projects[0].id, roomId: (db.projects[0].rooms||[])[0]?.id };

    let p = getProject(db.active.projectId);
    if(!p) { db.active.projectId = db.projects[0].id; p = getProject(db.active.projectId); }

    if(!p.rooms || p.rooms.length === 0) {
      p.rooms = [{ id: uid("r"), name:"æœ€åˆã®Room", pinned:false, updatedAt: nowIso(), messages:[], guidance: defaultGuidance() }];
    }

    let r = getRoom(db.active.projectId, db.active.roomId);
    if(!r) db.active.roomId = p.rooms[0].id;

    // guidance exists
    r = getRoom(db.active.projectId, db.active.roomId);
    if(!r.guidance) r.guidance = defaultGuidance();
    if(!r.guidance.steps) r.guidance.steps = [];
    if(typeof r.guidance.cursor !== "number") r.guidance.cursor = 0;
    if(!r.guidance.mode) r.guidance.mode = "normal";
  }

  function setActive(pid, rid) {
    db.active.projectId = pid;
    db.active.roomId = rid;
    saveDb();
    renderAll();
  }

  function sortRooms(rooms) {
    const list = [...(rooms || [])];
    list.sort((a,b) => {
      const ap = !!a.pinned, bp = !!b.pinned;
      if(ap !== bp) return ap ? -1 : 1;
      return (b.updatedAt||"").localeCompare(a.updatedAt||"");
    });
    return list;
  }

  function renderProjectSelect() {
    elProject.innerHTML = "";
    for(const p of db.projects) {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.name;
      elProject.appendChild(opt);
    }
    elProject.value = db.active.projectId;
  }

  function renderRooms() {
    const p = getProject(db.active.projectId);
    const q = (elSearch.value || "").trim().toLowerCase();
    elRoomList.innerHTML = "";

    const rooms = sortRooms(p.rooms || []);
    const filtered = rooms.filter(r => {
      if(!q) return true;
      if((r.name||"").toLowerCase().includes(q)) return true;
      const ms = r.messages || [];
      const last = ms[ms.length-1];
      return !!(last && (last.text||"").toLowerCase().includes(q));
    });

    for(const r of filtered) {
      const div = document.createElement("div");
      div.className = "roomItem" + (r.id === db.active.roomId ? " active" : "");
      div.addEventListener("click", () => setActive(p.id, r.id));

      const name = document.createElement("div");
      name.className = "roomName";
      name.textContent = r.name || "ï¼ˆç„¡åï¼‰";

      const meta = document.createElement("div");
      meta.className = "roomMeta";
      const ms = r.messages || [];
      const last = ms.length ? ms[ms.length-1] : null;
      const snippet = last ? last.text.slice(0, 26).replace(/\s+/g," ") + (last.text.length>26?"â€¦":"") : "ã¾ã ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—";
      meta.textContent = "æœ€å¾Œ: " + snippet + " / " + (r.updatedAt ? fmtTime(r.updatedAt) : "--:--:--") + " / " + ms.length + "ä»¶";

      div.appendChild(name);
      div.appendChild(meta);
      elRoomList.appendChild(div);
    }

    if(filtered.length === 0) {
      const empty = document.createElement("div");
      empty.className = "roomItem";
      empty.style.cursor = "default";
      empty.innerHTML = '<div class="roomName">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div><div class="roomMeta">æ¤œç´¢æ¡ä»¶ã‚’å¤‰ãˆã‚‹ã‹ã€æ–°ã—ã„Roomã‚’ä½œã£ã¦ã­ã€‚</div>';
      elRoomList.appendChild(empty);
    }
  }

  function setRightTab(tab) {
    db.ui = db.ui || {};
    db.ui.rightTab = tab;
    saveDb();
    renderRight();
  }

  function renderRightHeader() {
    const p = getProject(db.active.projectId);
    const r = getRoom(db.active.projectId, db.active.roomId);
    elChatTitle.textContent = "Roomï¼š " + (r?.name || "ï¼ˆç„¡åï¼‰");
    elChatSub.textContent = "Projectï¼š " + (p?.name || "") + " / ä¿å­˜å…ˆï¼šã“ã®ç«¯æœ«ã®ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰";
    const tab = (db.ui && db.ui.rightTab) ? db.ui.rightTab : "guidance";
    tabGuidance.classList.toggle("active", tab === "guidance");
    tabChat.classList.toggle("active", tab === "chat");
    tabGuidance.setAttribute("aria-selected", tab === "guidance" ? "true" : "false");
    tabChat.setAttribute("aria-selected", tab === "chat" ? "true" : "false");
  }

  function renderChat() {
    const r = getRoom(db.active.projectId, db.active.roomId);
    const ms = (r?.messages || []);
    const box = document.createElement("div");

    for(const m of ms) {
      const b = document.createElement("div");
      b.className = "bubble " + (m.role === "me" ? "me" : "");

      const meta = document.createElement("div");
      meta.className = "bMeta";

      const who = document.createElement("div");
      who.className = "who";
      who.textContent = (m.role === "me" ? "ãªã¹ã¡ã‚‡ã†ã•ã‚“" : DEFAULT_ASSISTANT_NAME);

      const time = document.createElement("div");
      time.className = "time";
      time.textContent = fmtTime(m.ts);

      meta.appendChild(who);
      meta.appendChild(time);

      const text = document.createElement("div");
      text.className = "bText";
      text.textContent = m.text || "";

      b.appendChild(meta);
      b.appendChild(text);
      box.appendChild(b);
    }
    elRightBody.innerHTML = "";
    elRightBody.appendChild(box);

    requestAnimationFrame(() => {
      elRightBody.scrollTop = elRightBody.scrollHeight + 9999;
    });
  }

  function renderGuidance() {
    const r = getRoom(db.active.projectId, db.active.roomId);
    const g = r.guidance || defaultGuidance();

    const wrap = document.createElement("div");
    wrap.className = "gWrap";

    // top controls
    const top = document.createElement("div");
    top.className = "gTop";

    const left = document.createElement("div");
    left.style.display = "flex";
    left.style.gap = "8px";
    left.style.flexWrap = "wrap";
    left.style.alignItems = "center";

    const tag = document.createElement("div");
    tag.className = "btn ghost";
    tag.style.cursor = "default";
    tag.innerHTML = '<span style="opacity:.85">ãƒ¢ãƒ¼ãƒ‰ï¼š</span><span class="mono">' + (g.mode === "small" ? "SMALL STEP" : "NORMAL") + '</span>';
    left.appendChild(tag);

    const btnToggle = document.createElement("button");
    btnToggle.className = "btn small";
    btnToggle.textContent = (g.mode === "small" ? "é€šå¸¸è¡¨ç¤ºã¸" : "1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸");
    btnToggle.addEventListener("click", () => {
      g.mode = (g.mode === "small") ? "normal" : "small";
      if(g.mode === "small") g.cursor = Math.min(g.cursor||0, Math.max(0, (g.steps||[]).length-1));
      r.guidance = g;
      r.updatedAt = nowIso();
      saveDb();
      renderGuidance();
      toast(g.mode === "small" ? "1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã—ã¾ã—ãŸ" : "é€šå¸¸è¡¨ç¤ºã«ã—ã¾ã—ãŸ");
    });
    left.appendChild(btnToggle);

    const btnAdd = document.createElement("button");
    btnAdd.className = "btn small primary";
    btnAdd.textContent = "ï¼‹ æŒ‡ç¤ºã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ";
    btnAdd.addEventListener("click", () => {
      const label = prompt("ãƒ©ãƒ™ãƒ«ï¼ˆä¾‹ï¼šA / B / C / Step 4ï¼‰");
      if(!label) return;
      const title = prompt("ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçŸ­ãï¼‰");
      if(!title) return;
      const text = prompt("æœ¬æ–‡ï¼ˆæ‰‹é †ï¼‰");
      if(!text) return;
      g.steps = g.steps || [];
      g.steps.push({ id: uid("s"), label: label.trim(), title: title.trim(), text, status:"active", qa:[] });
      r.guidance = g;
      r.updatedAt = nowIso();
      saveDb();
      renderGuidance();
      toast("è¿½åŠ ã—ã¾ã—ãŸ");
    });

    const right = document.createElement("div");
    right.style.display = "flex";
    right.style.gap = "8px";
    right.style.flexWrap = "wrap";
    right.style.justifyContent = "flex-end";

    const btnReset = document.createElement("button");
    btnReset.className = "btn small danger";
    btnReset.textContent = "æŒ‡ç¤ºã‚’åˆæœŸåŒ–";
    btnReset.addEventListener("click", () => {
      const ok = confirm("ã“ã®Roomã®Guidanceï¼ˆæŒ‡ç¤ºï¼‰ã‚’åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆChatã¯æ®‹ã‚Šã¾ã™ï¼‰");
      if(!ok) return;
      r.guidance = defaultGuidance();
      r.updatedAt = nowIso();
      saveDb();
      renderGuidance();
      toast("åˆæœŸåŒ–ã—ã¾ã—ãŸ");
    });

    top.appendChild(left);
    right.appendChild(btnReset);
    right.appendChild(btnAdd);
    top.appendChild(right);
    wrap.appendChild(top);

    // list
    const steps = (g.steps || []);

    const showList = (g.mode !== "small");
    const cursor = Math.max(0, Math.min(g.cursor || 0, Math.max(0, steps.length-1)));

    const list = showList ? steps.map((s,i) => ({s,i})) : (steps[cursor] ? [{s:steps[cursor], i:cursor}] : []);
    for(const item of list) {
      const s = item.s, idx = item.i;
      const card = document.createElement("div");
      card.className = "gCard" + (g.mode === "small" ? " smallstep" : "");

      const head = document.createElement("div");
      head.className = "gHead";

      const labelBox = document.createElement("div");
      labelBox.className = "gLabel";

      const tStep = document.createElement("span");
      tStep.className = "gTag step";
      tStep.textContent = String(s.label || ("#" + (idx+1)));
      labelBox.appendChild(tStep);

      const tTitle = document.createElement("div");
      tTitle.className = "gTitle";
      tTitle.textContent = s.title || "ï¼ˆç„¡é¡Œï¼‰";
      labelBox.appendChild(tTitle);

      if(s.status === "archived") {
        const arch = document.createElement("span");
        arch.className = "gTag arch";
        arch.textContent = "ARCHIVED";
        labelBox.appendChild(arch);
      }

      const btns = document.createElement("div");
      btns.className = "gBtns";

      const bAsk = document.createElement("button");
      bAsk.className = "btn small";
      bAsk.textContent = "â“ è³ªå•";
      bAsk.addEventListener("click", () => openAskFlow(idx));
      btns.appendChild(bAsk);

      const bEdit = document.createElement("button");
      bEdit.className = "btn small ghost";
      bEdit.textContent = "âœ ç·¨é›†";
      bEdit.addEventListener("click", () => {
        const nt = prompt("ã‚¿ã‚¤ãƒˆãƒ«", s.title || "");
        if(nt == null) return;
        const ntext = prompt("æœ¬æ–‡", s.text || "");
        if(ntext == null) return;
        s.title = nt.trim();
        s.text = ntext;
        r.updatedAt = nowIso();
        saveDb();
        renderGuidance();
        toast("æ›´æ–°ã—ã¾ã—ãŸ");
      });
      btns.appendChild(bEdit);

      const bDel = document.createElement("button");
      bDel.className = "btn small danger";
      bDel.textContent = "å‰Šé™¤";
      bDel.addEventListener("click", () => {
        const ok = confirm("ã“ã®æŒ‡ç¤ºã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n" + (s.label||"") + " " + (s.title||""));
        if(!ok) return;
        g.steps.splice(idx,1);
        g.cursor = Math.min(g.cursor||0, Math.max(0, g.steps.length-1));
        r.updatedAt = nowIso();
        saveDb();
        renderGuidance();
        toast("å‰Šé™¤ã—ã¾ã—ãŸ");
      });
      btns.appendChild(bDel);

      head.appendChild(labelBox);
      head.appendChild(btns);
      card.appendChild(head);

      const text = document.createElement("div");
      text.className = "gText";
      text.textContent = s.text || "";
      card.appendChild(text);

      // QA history (if exists)
      if(Array.isArray(s.qa) && s.qa.length) {
        const ans = document.createElement("div");
        ans.className = "gAnswer";
        const ttl = document.createElement("div");
        ttl.className = "ttl";
        ttl.textContent = "è³ªå•ã¨å›ç­”ï¼ˆã“ã®ã‚«ãƒ¼ãƒ‰ï¼‰";
        ans.appendChild(ttl);
        for(const qa of s.qa.slice(-5)) {
          const b = document.createElement("div");
          b.style.border = "1px solid rgba(255,255,255,0.10)";
          b.style.background = "rgba(0,0,0,0.10)";
          b.style.borderRadius = "14px";
          b.style.padding = "10px 10px";
          b.style.marginTop = "8px";
          b.innerHTML = '<div style="font-size:12px;color:rgba(255,255,255,0.55);">Q ('+ fmtTime(qa.ts) +')</div>' +
                        '<div style="white-space:pre-wrap;line-height:1.55;margin-top:4px;">'+ escapeHtml(qa.q) +'</div>' +
                        '<div style="font-size:12px;color:rgba(255,255,255,0.55);margin-top:8px;">A</div>' +
                        '<div style="white-space:pre-wrap;line-height:1.55;margin-top:4px;">'+ escapeHtml(qa.a||"ï¼ˆæœªå…¥åŠ›ï¼‰") +'</div>';
          ans.appendChild(b);
        }
        card.appendChild(ans);

        // å›ç­”ã‚’è²¼ã£ãŸã‚‰ï¼šã¤ã¥ãï¼ˆBä»¥é™ï¼‰ã‚’å‡ºã—ç›´ã™å°ç·š
        const bRe = document.createElement("button");
        bRe.className = "btn small primary";
        bRe.textContent = "â†» å›ç­”ã‚’è²¼ã£ãŸ â†’ ã¤ã¥ãã‚’å‡ºã—ç›´ã™";
        bRe.addEventListener("click", () => rebuildFrom(idx));
        ans.appendChild(document.createElement("div"));
        ans.appendChild(bRe);
      }

      // Small step footer controls
      if(g.mode === "small") {
        const footer = document.createElement("div");
        footer.style.marginTop = "10px";
        footer.style.display = "flex";
        footer.style.gap = "10px";
        footer.style.flexWrap = "wrap";
        footer.style.justifyContent = "space-between";
        footer.style.alignItems = "center";

        const leftCtl = document.createElement("div");
        leftCtl.style.display = "flex";
        leftCtl.style.gap = "8px";
        leftCtl.style.alignItems = "center";
        leftCtl.style.flexWrap = "wrap";

        const pos = document.createElement("div");
        pos.className = "gTag";
        pos.textContent = "é€²è¡Œ: " + (cursor+1) + " / " + steps.length;
        leftCtl.appendChild(pos);

        const bPrev = document.createElement("button");
        bPrev.className = "btn small ghost";
        bPrev.textContent = "â† å‰ã¸";
        bPrev.disabled = cursor <= 0;
        bPrev.addEventListener("click", () => {
          g.cursor = Math.max(0, cursor-1);
          r.updatedAt = nowIso();
          saveDb();
          renderGuidance();
        });

        const bDone = document.createElement("button");
        bDone.className = "btn small primary";
        bDone.textContent = "âœ“ å®Œäº†ï¼ˆæ¬¡ã¸ï¼‰";
        bDone.disabled = cursor >= steps.length-1;
        bDone.addEventListener("click", () => {
          g.cursor = Math.min(steps.length-1, cursor+1);
          r.updatedAt = nowIso();
          saveDb();
          renderGuidance();
          toast("æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸");
        });

        leftCtl.appendChild(bPrev);
        leftCtl.appendChild(bDone);

        const rightCtl = document.createElement("div");
        rightCtl.style.display = "flex";
        rightCtl.style.gap = "8px";
        rightCtl.style.flexWrap = "wrap";
        rightCtl.style.justifyContent = "flex-end";

        const bShowAll = document.createElement("button");
        bShowAll.className = "btn small";
        bShowAll.textContent = "ä¸€è¦§ã‚’è¦‹ã‚‹";
        bShowAll.addEventListener("click", () => {
          g.mode = "normal";
          r.updatedAt = nowIso();
          saveDb();
          renderGuidance();
        });
        rightCtl.appendChild(bShowAll);

        footer.appendChild(leftCtl);
        footer.appendChild(rightCtl);
        card.appendChild(footer);
      }

      wrap.appendChild(card);
    }

    // Help note
    const note = document.createElement("div");
    note.className = "gCard";
    note.innerHTML = '<div style="font-weight:850;font-size:13px;">åˆå¿ƒè€…å‘ã‘ã®å‹•ã</div>' +
      '<div style="margin-top:8px;color:rgba(255,255,255,0.72);font-size:12.5px;line-height:1.55;">' +
      'â‘  1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã«ã—ã¦ã€Œä»Šã‚„ã‚‹ã“ã¨ã€ã‚’1ã¤ã«çµã‚‹ â†’ â‘¡ åˆ†ã‹ã‚‰ãªã„èªã¯é¸æŠã—ã¦èª¬æ˜ â†’ â‘¢ ãã‚Œã§ã‚‚ãƒ€ãƒ¡ãªã‚‰ã€Œè³ªå•ã€ã§æ­¢ã‚ã‚‹ã€‚' +
      '</div>';
    wrap.appendChild(note);

    elRightBody.innerHTML = "";
    elRightBody.appendChild(wrap);
    requestAnimationFrame(() => {
      elRightBody.scrollTop = 0;
    });
  }

  function renderRight() {
    renderRightHeader();
    const tab = (db.ui && db.ui.rightTab) ? db.ui.rightTab : "guidance";
    if(tab === "chat") renderChat();
    else renderGuidance();
  }

  function renderAll() {
    ensureActive();
    renderProjectSelect();
    renderRooms();
    renderRight();
  }

  // --- Ask Flow: question => archive later steps => store QA => (optional) rebuild later
  function openAskFlow(stepIndex) {
    const r = getRoom(db.active.projectId, db.active.roomId);
    const g = r.guidance || defaultGuidance();
    const s = g.steps[stepIndex];
    if(!s) return;

    const q = prompt("è³ªå•ã‚’æ›¸ã„ã¦ã­ï¼ˆä¾‹ï¼šBã®ã€Hostingã€ã£ã¦ã©ã“ï¼Ÿï¼‰");
    if(!q) return;

    // â€œãã‚Œä»¥é™ã®æŒ‡ç¤ºâ€ã¯ä¸€æ—¦ãŸãŸã‚€ï¼ˆå‰Šé™¤ã§ã¯ãªãARCHIVEDã§å±¥æ­´ã¯ä¿æŒï¼‰
    for(let i=stepIndex+1;i<g.steps.length;i++) {
      if(g.steps[i].status !== "archived") g.steps[i].status = "archived";
    }

    s.qa = s.qa || [];
    s.qa.push({ q, a: "ï¼ˆã“ã“ã«ãƒ¦ã‚¤ã®å›ç­”ã‚’è²¼ã‚‹ï¼å¾Œã§AIæ¥ç¶šã§è‡ªå‹•å…¥åŠ›ï¼‰", ts: nowIso() });

    r.updatedAt = nowIso();
    r.guidance = g;
    saveDb();

    // Chatã«ã‚‚æ®‹ã—ã¦â€œä¼šè©±ã£ã½ãâ€
    r.messages = r.messages || [];
    r.messages.push({ id: uid("m"), role:"me", text: "ã€è³ªå•ã€‘" + (s.label ? s.label + "ï¼š" : "") + " " + q, ts: nowIso() });
    r.messages.push({ id: uid("m"), role:"you", text: "ã€å›ç­”ï¼ˆä»®ï¼‰ã€‘ã“ã®å›ç­”æ¬„ã«è²¼ã£ã¦ã­ã€‚è²¼ã£ãŸã‚‰â€œã¤ã¥ãå†ä½œæˆâ€ã§Bä»¥é™ã‚’å‡ºã—ç›´ã›ã‚‹ã‚ˆã€‚", ts: nowIso() });
    saveDb();

    toast("è³ªå•ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆä»¥é™ã®æŒ‡ç¤ºã¯ä¸€æ—¦ãŸãŸã¿ã¾ã—ãŸï¼‰");
    // ãƒ¦ã‚¤ã«ãã®ã¾ã¾è²¼ã‚Œã‚‹â€œè³ªå•ãƒ†ãƒ³ãƒ—ãƒ¬â€ã‚’Chatã«è¿½åŠ ï¼ˆä¼šè©±ã®æ‘©æ“¦ã‚’ä¸‹ã’ã‚‹ï¼‰
    const yuiPrompt =
      "ã€" + (s.label ? s.label + "ã®è³ªå•" : "è³ªå•") + "ã€‘\n" +
      q + "\n\n" +
      "å‰æï¼šç§ã¯åˆå¿ƒè€…ã§ã™ã€‚ä»Šã‚„ã‚‹ã“ã¨ã¯1ã¤ã ã‘ã«ã—ã¦ãã ã•ã„ã€‚\n" +
      "æ¬¡ã®å‡ºåŠ›å½¢å¼ã§ãŠé¡˜ã„ã—ã¾ã™ï¼š\n" +
      "1) ã¾ãšçµè«–ï¼ˆä½•ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼‰\n" +
      "2) ã‚¯ãƒªãƒƒã‚¯çµŒè·¯ï¼ˆã©ã“â†’ã©ã‚Œâ†’ã©ã“ï¼‰\n" +
      "3) ãã®ç†ç”±ï¼ˆçŸ­ãï¼‰\n" +
      "4) æ¬¡ã®1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ1ã¤ã ã‘ï¼‰\n";
    r.messages.push({ id: uid("m"), role:"me", text: "ã€ãƒ¦ã‚¤ã«æŠ•ã’ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ã€‘\n" + yuiPrompt, ts: nowIso() });

    setRightTab("guidance");

    const doRebuild = confirm("å›ç­”ã‚’è²¼ã£ãŸå¾Œã«ã€Bä»¥é™ï¼ˆãŸãŸã‚“ã æŒ‡ç¤ºï¼‰ã‚’â€œå‡ºã—ç›´ã—â€ã—ãŸã„ï¼Ÿ\n\nOKï¼ä»Šã™ãå†ä½œæˆã®é››å½¢ã‚’å‡ºã™\nã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ã‚ã¨ã§");
    if(doRebuild) {
      rebuildFrom(stepIndex);
    } else {
      renderGuidance();
    }
  }

  function rebuildFrom(stepIndex) {
    const r = getRoom(db.active.projectId, db.active.roomId);
    const g = r.guidance || defaultGuidance();
    const base = g.steps[stepIndex];
    if(!base) return;

    const kept = g.steps.slice(0, stepIndex+1);
    const newSteps = [
      {
        id: uid("s"),
        label: "ï¼ˆç¶šãï¼‰",
        title: "Bä»¥é™ã®æŒ‡ç¤ºï¼ˆå‡ºã—ç›´ã—ï¼‰",
        text:
          "ã“ã“ã«â€œæ”¹ã‚ã¦â€Bä»¥é™ã®æŒ‡ç¤ºã‚’è²¼ã‚Šã¾ã™ã€‚\n" +
          "ä¾‹ï¼š\n" +
          "Step Bï¼šã€œã€œï¼ˆ1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰\n" +
          "Step Cï¼šã€œã€œï¼ˆ1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‰\n\n" +
          "â€» ãƒ¦ã‚¤ãŒæŒ‡ç¤ºã‚’å‡ºã—ãŸã‚‰ã€ã“ã®ã‚«ãƒ¼ãƒ‰ã®æœ¬æ–‡ã‚’ç½®ãæ›ãˆã¦ä½¿ã£ã¦ã­ã€‚",
        status: "active",
        qa: []
      }
    ];
    g.steps = kept.concat(newSteps);
    g.cursor = Math.min(g.cursor||0, Math.max(0, g.steps.length-1));
    r.guidance = g;
    r.updatedAt = nowIso();
    saveDb();
    renderGuidance();
    toast("â€œã¤ã¥ãå‡ºã—ç›´ã—â€ã®ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚Šã¾ã—ãŸ");
  }

  function escapeHtml(s) {
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // --- UI handlers
  elProject.addEventListener("change", () => {
    const pid = elProject.value;
    const p = getProject(pid);
    if(!p) return;
    db.active.projectId = pid;
    db.active.roomId = (p.rooms && p.rooms.length) ? p.rooms[0].id : null;
    saveDb();
    renderAll();
  });

  elSearch.addEventListener("input", renderRooms);

  tabGuidance.addEventListener("click", () => setRightTab("guidance"));
  tabChat.addEventListener("click", () => setRightTab("chat"));

  $("btnNewProject").addEventListener("click", () => {
    const name = prompt("æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåï¼ˆä¾‹ï¼šLexiTrainerï¼‰");
    if(!name) return;
    const pid = uid("p");
    db.projects.push({ id: pid, name: name.trim(), rooms:[{ id: uid("r"), name:"æœ€åˆã®Room", pinned:false, updatedAt: nowIso(), messages:[], guidance: defaultGuidance() }] });
    db.active.projectId = pid;
    db.active.roomId = db.projects[db.projects.length-1].rooms[0].id;
    saveDb();
    renderAll();
    toast("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚Šã¾ã—ãŸ");
  });

  $("btnNewRoom").addEventListener("click", () => {
    const p = getProject(db.active.projectId);
    const name = prompt("æ–°ã—ã„Roomåï¼ˆä¾‹ï¼šUIä¿®æ­£ã€åŒæœŸèª¿æŸ»ã€è¨­è¨ˆãƒ¡ãƒ¢ï¼‰");
    if(!name) return;
    const rid = uid("r");
    p.rooms.push({ id: rid, name: name.trim(), pinned:false, updatedAt: nowIso(), messages:[], guidance: defaultGuidance() });
    db.active.roomId = rid;
    saveDb();
    renderAll();
    toast("Roomã‚’ä½œã‚Šã¾ã—ãŸ");
  });

  function send(role) {
    const text = (elMsg.value || "").trim();
    if(!text) return;
    const r = getRoom(db.active.projectId, db.active.roomId);
    r.messages = r.messages || [];
    r.messages.push({ id: uid("m"), role, text, ts: nowIso() });
    r.updatedAt = nowIso();
    elMsg.value = "";
    saveDb();
    if((db.ui && db.ui.rightTab) === "chat") renderChat();
  }

  $("btnSend").addEventListener("click", () => send("me"));
  elMsg.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      send("me");
    }
  });

  $("btnRoomRename").addEventListener("click", () => {
    const r = getRoom(db.active.projectId, db.active.roomId);
    const name = prompt("Roomåã‚’å¤‰æ›´", r.name || "");
    if(!name) return;
    r.name = name.trim();
    r.updatedAt = nowIso();
    saveDb();
    renderAll();
    toast("åå‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ");
  });

  $("btnRoomPin").addEventListener("click", () => {
    const r = getRoom(db.active.projectId, db.active.roomId);
    r.pinned = !r.pinned;
    r.updatedAt = nowIso();
    saveDb();
    renderRooms();
    toast(r.pinned ? "ãƒ”ãƒ³ç•™ã‚ã—ã¾ã—ãŸ" : "ãƒ”ãƒ³ã‚’å¤–ã—ã¾ã—ãŸ");
  });

  $("btnRoomClone").addEventListener("click", () => {
    const p = getProject(db.active.projectId);
    const r = getRoom(db.active.projectId, db.active.roomId);
    const nr = {
      id: uid("r"),
      name: (r.name || "Room") + "ï¼ˆè¤‡è£½ï¼‰",
      pinned: false,
      updatedAt: nowIso(),
      messages: structuredClone(r.messages || []),
      guidance: structuredClone(r.guidance || defaultGuidance())
    };
    p.rooms.push(nr);
    db.active.roomId = nr.id;
    saveDb();
    renderAll();
    toast("è¤‡è£½ã—ã¾ã—ãŸ");
  });

  $("btnRoomDelete").addEventListener("click", () => {
    const p = getProject(db.active.projectId);
    if(!p || !p.rooms) return;
    if(p.rooms.length <= 1) { toast("æœ€å¾Œã®Roomã¯å‰Šé™¤ã§ãã¾ã›ã‚“"); return; }
    const r = getRoom(db.active.projectId, db.active.roomId);
    const ok = confirm("ã“ã®Roomã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå¾©å…ƒã§ãã¾ã›ã‚“ã€‚å¿…è¦ãªã‚‰å…ˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰\n\nRoom: " + (r?.name || ""));
    if(!ok) return;
    p.rooms = p.rooms.filter(x => x.id !== db.active.roomId);
    db.active.roomId = p.rooms[0].id;
    saveDb();
    renderAll();
    toast("å‰Šé™¤ã—ã¾ã—ãŸ");
  });

  // --- Export/Import modal
  function openModal(which) {
    overlay.classList.add("show");
    overlay.setAttribute("aria-hidden","false");
    modeExport.style.display = "none";
    modeImport.style.display = "none";
    modeTerm.style.display = "none";

    if(which === "export") {
      modalTitle.textContent = "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ";
      modalDesc.textContent = "ã“ã®JSONã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¿å­˜ã—ã¦ãŠãã¨ã€ã‚ã¨ã§å¾©å…ƒã§ãã¾ã™ã€‚";
      modeExport.style.display = "block";
      taJson.value = JSON.stringify(db, null, 2);
      taJson.focus();
    } else if(which === "import") {
      modalTitle.textContent = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆ";
      modalDesc.textContent = "JSONã‚’è²¼ã£ã¦ã€Œåæ˜ ã€ã™ã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆã¾ã™ï¼ˆè¿·å­é˜²æ­¢ï¼‰ã€‚";
      modeImport.style.display = "block";
      taJsonIn.value = "";
      taJsonIn.focus();
    } else if(which === "term") {
      modeTerm.style.display = "block";
    }
  }
  function closeModal() {
    overlay.classList.remove("show");
    overlay.setAttribute("aria-hidden","true");
  }

  $("btnExport").addEventListener("click", () => openModal("export"));
  $("btnImport").addEventListener("click", () => openModal("import"));
  $("btnClose").addEventListener("click", closeModal);
  overlay.addEventListener("click", (e) => { if(e.target === overlay) closeModal(); });

  $("btnCopy").addEventListener("click", async () => {
    try { await navigator.clipboard.writeText(taJson.value || ""); toast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"); }
    catch(e) { toast("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ï¼ˆæ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã­ï¼‰"); }
  });

  $("btnPaste").addEventListener("click", async () => {
    try {
      const t = await navigator.clipboard.readText();
      if(t) taJsonIn.value = t;
      toast("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ");
    } catch(e) {
      toast("è²¼ã‚Šä»˜ã‘ã§ãã¾ã›ã‚“ï¼ˆæ‰‹å‹•ã§è²¼ã£ã¦ã­ï¼‰");
    }
  });

  $("btnApply").addEventListener("click", () => { closeModal(); toast("OK"); });
  $("btnApplyIn").addEventListener("click", () => {
    const raw = (taJsonIn.value || "").trim();
    if(!raw) { toast("JSONãŒç©ºã§ã™"); return; }
    try {
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object" || !Array.isArray(obj.projects)) { toast("å½¢å¼ãŒé•ã„ã¾ã™"); return; }
      db = obj;
      ensureActive();
      saveDb();
      renderAll();
      closeModal();
      toast("ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ");
    } catch(e) {
      toast("JSONãŒå£Šã‚Œã¦ã„ã¾ã™");
    }
  });

  $("btnTermClose").addEventListener("click", closeModal);

  // --- Term selection handler (Guidance text only)
  function showTermExplain(word) {
    const w = (word || "").trim();
    if(!w) return;

    // try exact and fuzzy
    let hitKey = null;
    if(TERM[w]) hitKey = w;
    else {
      const keys = Object.keys(TERM);
      let best = null;
      for(const k of keys) {
        if(k.includes(w) || w.includes(k)) {
          if(!best || k.length > best.length) best = k;
        }
      }
      hitKey = best;
    }

    if(!hitKey) {
      toast("æœªç™»éŒ²ã®ç”¨èªï¼š " + w + "ï¼ˆå¿…è¦ãªã‚‰è¾æ›¸ã«è¿½åŠ ã™ã‚‹ã­ï¼‰");
      return;
    }

    toast(hitKey + "ï¼š " + TERM[hitKey].short + "ï¼ˆè©³ã—ãâ†’åˆ¥ç”»é¢ï¼‰");

    const ok = confirm("ç”¨èªã®è©³ã—ã„èª¬æ˜ã‚’è¦‹ã‚‹ï¼Ÿ\n\n" + hitKey);
    if(!ok) return;

    termWord.textContent = hitKey;
    termLong.textContent = TERM[hitKey].long || "";
    modalTitle.textContent = "ç”¨èªã®èª¬æ˜";
    modalDesc.textContent = "";
    openModal("term");
  }

  document.addEventListener("selectionchange", () => {
    if(!db || (db.ui && db.ui.rightTab) !== "guidance") return;
    const sel = window.getSelection();
    if(!sel || sel.isCollapsed) return;

    const txt = (sel.toString() || "").trim();
    if(!txt) return;
    if(txt.length > 26) return;

    try {
      const node = sel.anchorNode;
      if(!node) return;
      if(!elRightBody.contains(node)) return;
    } catch(e) { return; }

    clearTimeout(window.__termTimer);
    window.__termTimer = setTimeout(() => {
      const sel2 = window.getSelection();
      if(!sel2 || sel2.isCollapsed) return;
      const t2 = (sel2.toString() || "").trim();
      if(!t2 || t2.length > 26) return;
      showTermExplain(t2);
      sel2.removeAllRanges();
    }, 260);
  });

  // Init

  // UI font scale
  applyUiScale(loadUiScale());
  const bS = document.getElementById("btnFontS");
  const bM = document.getElementById("btnFontM");
  const bL = document.getElementById("btnFontL");
  if(bS) bS.addEventListener("click", () => { applyUiScale(0.95); toast("æ–‡å­—ï¼šå°"); });
  if(bM) bM.addEventListener("click", () => { applyUiScale(1.00); toast("æ–‡å­—ï¼šä¸­"); });
  if(bL) bL.addEventListener("click", () => { applyUiScale(1.12); toast("æ–‡å­—ï¼šå¤§"); });

  db = loadDb();
  ensureActive();
  saveDb();

  if(!db.ui) db.ui = { rightTab: "guidance" };
  if(!db.ui.rightTab) db.ui.rightTab = "guidance";

  renderAll();
  toast("v0.3.2ï¼šã‚¢ã‚¤ã‚³ãƒ³è¨­å®šï¼æ–‡å­—ã‚µã‚¤ã‚ºï¼ˆå°ãƒ»ä¸­ãƒ»å¤§ï¼‰");
})();
</script>
</body>
</html>
