<!DOCTYPE html>
<html lang="ja">
<head>
  <!--
  APP: Anchorï¼ˆAIãŒèãMDæ”¯æ´ï¼‰
  FILE: app/index.html
  VERSION: v0.4.2-nodialog
  DATE(JST): 2026-01-08 07:24 JST
  TITLE: ãƒ–ãƒ©ã‚¦ã‚¶ã®confirm/promptã‚’å…¨å»ƒï¼ˆå…¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ã‚¢ãƒ—ãƒªå†…ãƒ¢ãƒ¼ãƒ€ãƒ«ã¸çµ±ä¸€ï¼‰
  CHANGES:
  - confirm/prompt/alert ã‚’ä¸€åˆ‡ä½¿ã‚ãªã„ï¼ˆãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ãƒ»æ“ä½œãŒæ­¢ã¾ã‚‹å•é¡Œã‚’è§£æ¶ˆï¼‰
  - æ—¢å­˜ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆâš™ã®ä¸­èº«ï¼‰ã‚’æ‹¡å¼µã—ã€ç¢ºèªãƒ»å…¥åŠ›ã‚‚åŒã˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã§å‡¦ç†
  - æ—¢å­˜UIã®è¦‹ãŸç›®/é…ç½®ã¯å¤‰æ›´ãªã—ï¼ˆå†…éƒ¨å®Ÿè£…ã®ã¿ï¼‰
  AUTHOR: Yui
  BUILD_PARAM: ?b=2026-01-08_0724_nodialog-v042
  DEBUG_PARAM: &debug=1
  POLICY: UIã¯ä¸€åˆ‡è§¦ã‚‰ãšå†…éƒ¨ã ã‘ç›´ã™
  -->

  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <meta name="theme-color" content="#0b1220"/>
  <title>Anchor â€” AIãŒèãMDæ”¯æ´ v0.4.2</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1a2c; --panel2:#121f35;
      --text:#e6eefc; --muted:#9bb0d3; --line:#20314d;
      --accent:#4fb6ff; --ok:#2dd4bf; --warn:#fbbf24; --bad:#fb7185;
      --btn:#162744; --btn2:#1b3054; --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,"Segoe UI","Noto Sans JP",sans-serif;
      background:linear-gradient(180deg,#061021 0%,#0b1220 40%,#060d18 100%);
      color:var(--text);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:18px 16px 28px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; padding:12px 14px; border:1px solid var(--line);
      border-radius:var(--radius); background:rgba(15,26,44,.72);
      box-shadow:var(--shadow); backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:34px; height:34px; border-radius:12px;
      display:grid; place-items:center;
      background:linear-gradient(135deg,#1b2f55,#0e1b31);
      border:1px solid #27406a;
    }
    .logo span{font-weight:700; color:#bfe7ff}
    .titleBlock{display:flex; flex-direction:column; line-height:1.12}
    .titleBlock .h{font-weight:750; letter-spacing:.2px}
    .titleBlock .s{font-size:12px; color:var(--muted)}
    .actions{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .btn{
      background:var(--btn); border:1px solid var(--line); color:var(--text);
      padding:9px 12px; border-radius:12px; cursor:pointer;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
      user-select:none;
    }
    .btn:hover{background:var(--btn2)}
    .btn.primary{background:linear-gradient(135deg,#1d8cff,#2dd4bf); border:0; color:#061021; font-weight:700}
    .btn.ghost{background:transparent}
    .btn.small{padding:7px 10px; border-radius:10px; font-size:13px}
    .btn.bad{background:rgba(251,113,133,.12); border:1px solid rgba(251,113,133,.35); color:#ffd3db}
    .btn.ok{background:rgba(45,212,191,.12); border:1px solid rgba(45,212,191,.35); color:#bff7ee}
    .pill{
      font-size:12px; padding:5px 10px; border-radius:999px;
      border:1px solid var(--line); color:var(--muted);
      background:rgba(11,18,32,.35);
    }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(15,26,44,.72);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(18,31,53,.75);
    }
    .card .hd .h{
      font-weight:750; letter-spacing:.2px;
    }
    .card .bd{padding:12px 14px}
    .muted{color:var(--muted); font-size:13px; line-height:1.45}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}

    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: calc(100vh - 250px);
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(11,18,32,.35);
      padding:10px 10px 10px 12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .itemTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:8px;
    }
    .itemTitle{font-weight:750}
    .tag{
      font-size:11px; padding:4px 9px; border-radius:999px; border:1px solid var(--line);
      color:#cde3ff; background:rgba(79,182,255,.12);
    }
    .itemText{
      font-size:13px; color:var(--muted); line-height:1.5; white-space:pre-wrap;
    }

    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(11,18,32,.35);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .tab.active{
      background:rgba(79,182,255,.16);
      color:#d7efff;
      border-color:rgba(79,182,255,.35);
    }

    textarea, input{
      width:100%;
      border:1px solid var(--line);
      background:rgba(11,18,32,.35);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:160px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .sep{height:1px; background:var(--line); margin:10px 0}
    .kvs{display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center}
    .kvs label{font-size:12px; color:var(--muted)}
    .kvs input{font-size:13px; padding:8px 10px; border-radius:10px}

    /* toast */
    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom:18px; z-index:9999;
      padding:10px 14px;
      border-radius:999px;
      background:rgba(15,26,44,.95);
      border:1px solid rgba(79,182,255,.28);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
      color:var(--text);
      font-size:13px;
      opacity:0; pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
    }
    #toast.show{opacity:1; transform:translateX(-50%) translateY(-2px)}

    /* overlay modal (æ—¢å­˜UIã®ã¾ã¾æ‹¡å¼µ) */
    #overlay{
      position:fixed; inset:0; z-index:9000;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
    }
    #modal{
      width:min(920px, 96vw);
      border-radius:18px;
      border:1px solid rgba(79,182,255,.25);
      background:rgba(15,26,44,.96);
      box-shadow:0 18px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    #modalHeader{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background:rgba(18,31,53,.75);
    }
    #modalHeader .mh{font-weight:750}
    #modalHeader .ms{font-size:12px; color:var(--muted)}
    #modalBody{padding:12px 14px}
    .modalBtns{display:flex; justify-content:flex-end; gap:8px; margin-top:10px; flex-wrap:wrap}

    /* small inline buttons */
    .ibtn{cursor:pointer; font-size:12px; color:#cfeaff; text-decoration:underline; opacity:.9}
    .ibtn:hover{opacity:1}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"><span>A</span></div>
        <div class="titleBlock">
          <div class="h">Anchorï¼ˆAIãŒèãMDæ”¯æ´ï¼‰</div>
          <div class="s">åŒã˜ç”»é¢ãƒ»åŒã˜è¨€è‘‰ã§è¿·ã‚ãªã„ã‚ˆã†ã«ã€‚è³ªå•â†’ç¢ºèªâ†’æŒ‡ç¤ºæ›¸ã‚’è‡ªå‹•æ•´å½¢ã€‚</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn ghost small" id="btnQuickHelp">ï¼Ÿ ä½¿ã„æ–¹</button>
        <button class="btn small" id="btnAskFlow">è³ªå•ã—ã¦ã€ŒæŒ‡ç¤ºæ›¸ã€ã‚’ä½œã‚‹</button>
        <button class="btn small" id="btnExport">å‡ºåŠ›ï¼ˆMDï¼‰</button>
        <button class="btn small" id="btnImport">èª­è¾¼ï¼ˆMDï¼‰</button>
        <button class="btn small" id="btnSettings">âš™ è¨­å®š</button>
        <button class="btn ghost small" title="ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±">
          <span class="mono">v0.4.2</span>
          <span class="pill mono">2026-01-08_0724_nodialog-v042</span>
        </button>
      </div>
    </div>

    <div class="grid">
      <!-- left -->
      <div class="card">
        <div class="hd">
          <div class="h">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</div>
          <div class="row">
            <button class="btn small" id="btnNewProject">ï¼‹ æ–°è¦</button>
          </div>
        </div>
        <div class="bd">
          <div class="tabs" id="projectTabs"></div>
          <div class="sep"></div>
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div class="col" style="flex:1">
              <div class="muted">ãƒ«ãƒ¼ãƒ ï¼ˆä½œæ¥­éƒ¨å±‹ï¼‰</div>
              <div class="tabs" id="roomTabs"></div>
              <div class="row">
                <button class="btn small" id="btnNewRoom">ï¼‹ ãƒ«ãƒ¼ãƒ </button>
                <button class="btn small" id="btnRoomRename">åç§°å¤‰æ›´</button>
                <button class="btn small bad" id="btnRoomDelete">å‰Šé™¤</button>
              </div>
            </div>
          </div>
          <div class="sep"></div>
          <div class="muted">
            <span class="mono">1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æŒ‡ç¤º</span>ã‚’å®ˆã‚‹ãŸã‚ã«ã€ã‚«ãƒ¼ãƒ‰ã‚’é›†ã‚ã¦æœ€å¾Œã«MDã§å‡ºåŠ›ã—ã¾ã™ã€‚<br/>
            ãƒ–ãƒ©ã‚¦ã‚¶ã®ã€Œç¢ºèª/å…¥åŠ›ã€ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã¯ä½¿ã„ã¾ã›ã‚“ï¼ˆå…¨éƒ¨ã‚¢ãƒ—ãƒªå†…ï¼‰ã€‚
          </div>
        </div>
      </div>

      <!-- right -->
      <div class="card">
        <div class="hd">
          <div class="h">æŒ‡ç¤ºã‚«ãƒ¼ãƒ‰</div>
          <div class="row">
            <button class="btn small ok" id="btnAdd">ï¼‹ è¿½åŠ </button>
            <button class="btn small" id="btnCopyAll">ğŸ“‹ å…¨ã‚³ãƒ”ãƒ¼</button>
            <button class="btn small bad" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
        <div class="bd">
          <div class="row">
            <div class="pill" id="ctxPill">â€”</div>
            <div class="muted" id="ctxSub" style="flex:1">â€”</div>
          </div>
          <div class="sep"></div>
          <div class="list" id="cardList"></div>

          <div class="sep"></div>
          <div class="muted">
            ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã™ã‚‹ã¨ç”¨èªå€™è£œã‚’å‡ºã—ã¾ã™ï¼ˆå¿…è¦ãªã‚‰èª¬æ˜ã‚‚è¦‹ã‚‰ã‚Œã¾ã™ï¼‰ã€‚
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast"></div>

  <!-- overlay modal -->
  <div id="overlay" role="dialog" aria-modal="true">
    <div id="modal">
      <div id="modalHeader">
        <div>
          <div class="mh" id="modalTitle">è¨­å®š</div>
          <div class="ms" id="modalDesc">è¡¨ç¤ºãƒ»å‡ºåŠ›ã®èª¿æ•´</div>
        </div>
        <button class="btn small ghost" id="btnClose">âœ•</button>
      </div>
      <div id="modalBody">

        <!-- ê¸°ì¡´(è¨­å®š/å‡ºåŠ›/èª­è¾¼/ç”¨èª)ãƒ¢ãƒ¼ãƒ‰ï¼šãã®ã¾ã¾ -->
        <div id="modalModeSettings">
          <div class="kvs">
            <label>æ–‡å­—ã‚µã‚¤ã‚º</label>
            <div class="row">
              <button class="btn small" data-font="S">å°</button>
              <button class="btn small" data-font="M">ä¸­</button>
              <button class="btn small" data-font="L">å¤§</button>
            </div>

            <label>å‡ºåŠ›ãƒ†ãƒ³ãƒ—ãƒ¬</label>
            <input id="tplName" placeholder="ä¾‹ï¼šæ—¥æœ¬èªIssueå‹ï¼ˆæ—¢å®šï¼‰" />

            <label>ã‚³ãƒ”ãƒ¼å¾Œã®è¡¨ç¤º</label>
            <input id="afterCopy" placeholder="ä¾‹ï¼šã€ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€ã ã‘è¡¨ç¤ºï¼ˆæ¨å¥¨ï¼‰" />

            <label>ãƒ’ãƒ³ãƒˆ</label>
            <div class="muted">è¨­å®šã¯ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã™ã€‚UIã®è¦‹ãŸç›®ã¯å¤‰ãˆãšã«ã€å‹•ãã ã‘æ•´ãˆã¾ã™ã€‚</div>
          </div>
          <div class="modalBtns">
            <button class="btn" id="btnSaveSettings">ä¿å­˜</button>
          </div>
        </div>

        <div id="modalModeExport" style="display:none">
          <textarea id="exportArea" class="mono" style="min-height:260px"></textarea>
          <div class="modalBtns">
            <button class="btn ok" id="btnCopyExport">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
          </div>
        </div>

        <div id="modalModeImport" style="display:none">
          <textarea id="importArea" class="mono" placeholder="ã“ã“ã«MDã‚’è²¼ã‚Šä»˜ã‘ã¦ã€èª­ã¿è¾¼ã‚€ã€"></textarea>
          <div class="modalBtns">
            <button class="btn primary" id="btnDoImport">èª­ã¿è¾¼ã‚€</button>
          </div>
          <div class="hint">â€» æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã«ä¸Šæ›¸ãã—ã¾ã™ï¼ˆç¢ºèªã¯ã‚¢ãƒ—ãƒªå†…ã§å‡ºã¾ã™ï¼‰ã€‚</div>
        </div>

        <div id="modalModeTerm" style="display:none">
          <div class="muted" id="termBrief">â€”</div>
          <div class="sep"></div>
          <div class="muted" id="termDetail" style="white-space:pre-wrap; line-height:1.6">â€”</div>
        </div>

        <!-- â˜…è¿½åŠ ï¼šconfirm/prompt ã‚’ç½®ãæ›ãˆã‚‹ â€œã‚¢ãƒ—ãƒªå†…ãƒ€ã‚¤ã‚¢ãƒ­ã‚°â€ -->
        <div id="modalModeConfirm" style="display:none">
          <div id="confirmMsg" style="white-space:pre-wrap; line-height:1.6"></div>
          <div class="modalBtns">
            <button class="btn ghost" id="btnConfirmCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn primary" id="btnConfirmOk" type="button">OK</button>
          </div>
        </div>

        <div id="modalModePrompt" style="display:none">
          <label id="promptLabel" for="promptInput" class="muted" style="display:block; margin-bottom:6px">å…¥åŠ›</label>
          <input id="promptInput" />
          <textarea id="promptArea" class="mono" style="min-height:180px; display:none"></textarea>
          <div class="modalBtns">
            <button class="btn ghost" id="btnPromptCancel" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="btn primary" id="btnPromptOk" type="button">OK</button>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(() => {
  "use strict";

  // =========================================================
  // APP META
  // =========================================================
  const APP_VERSION = "v0.4.2-nodialog";
  const BUILD_ID = "2026-01-08_0724_nodialog-v042";
  const STORAGE_KEY = "anchor_state_v1";
  const SETTINGS_KEY = "anchor_settings_v1";

  // =========================================================
  // UTILS
  // =========================================================
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  const toastEl = $("#toast");
  let toastTimer = null;
  function toast(msg, ms=1800){
    if(!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toastEl.classList.remove("show"), ms);
  }

  function nowIso(){
    const d = new Date();
    const pad = n => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

  // =========================================================
  // STATE
  // =========================================================
  const DEFAULT_STATE = {
    projects: [
      {
        id:"p1", name:"Anchor",
        rooms: [
          { id:"r1", name:"ãƒ¡ã‚¤ãƒ³", cards: [] }
        ]
      }
    ],
    currentProjectId:"p1",
    currentRoomId:"r1",
  };

  let state = loadState();
  let settings = loadSettings();

  // =========================================================
  // ELEMENTS
  // =========================================================
  const projectTabs = $("#projectTabs");
  const roomTabs = $("#roomTabs");
  const cardList = $("#cardList");
  const ctxPill = $("#ctxPill");
  const ctxSub = $("#ctxSub");

  const btnNewProject = $("#btnNewProject");
  const btnNewRoom = $("#btnNewRoom");
  const btnRoomRename = $("#btnRoomRename");
  const btnRoomDelete = $("#btnRoomDelete");

  const btnAdd = $("#btnAdd");
  const btnCopyAll = $("#btnCopyAll");
  const btnReset = $("#btnReset");

  const btnAskFlow = $("#btnAskFlow");
  const btnQuickHelp = $("#btnQuickHelp");

  const btnExport = $("#btnExport");
  const btnImport = $("#btnImport");
  const btnSettings = $("#btnSettings");

  // modal base
  const overlay = $("#overlay");
  const modalTitle = $("#modalTitle");
  const modalDesc = $("#modalDesc");
  const modalModeSettings = $("#modalModeSettings");
  const modalModeExport = $("#modalModeExport");
  const modalModeImport = $("#modalModeImport");
  const modalModeTerm = $("#modalModeTerm");
  const modalModeConfirm = $("#modalModeConfirm");
  const modalModePrompt = $("#modalModePrompt");

  const btnClose = $("#btnClose");

  // settings mode
  const tplName = $("#tplName");
  const afterCopy = $("#afterCopy");
  const btnSaveSettings = $("#btnSaveSettings");

  // export/import mode
  const exportArea = $("#exportArea");
  const btnCopyExport = $("#btnCopyExport");
  const importArea = $("#importArea");
  const btnDoImport = $("#btnDoImport");

  // term mode
  const termBrief = $("#termBrief");
  const termDetail = $("#termDetail");

  // confirm/prompt mode
  const confirmMsg = $("#confirmMsg");
  const btnConfirmOk = $("#btnConfirmOk");
  const btnConfirmCancel = $("#btnConfirmCancel");

  const promptLabel = $("#promptLabel");
  const promptInput = $("#promptInput");
  const promptArea = $("#promptArea");
  const btnPromptOk = $("#btnPromptOk");
  const btnPromptCancel = $("#btnPromptCancel");

  // =========================================================
  // MODAL CONTROLLER (ãƒ–ãƒ©ã‚¦ã‚¶ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ä»£æ›¿)
  // =========================================================
  let modalDyn = null; // { type: "confirm"|"prompt", resolve: fn, cancelValue: any }

  function hideAllModalModes(){
    modalModeSettings.style.display = "none";
    modalModeExport.style.display = "none";
    modalModeImport.style.display = "none";
    modalModeTerm.style.display = "none";
    modalModeConfirm.style.display = "none";
    modalModePrompt.style.display = "none";
  }

  function openModal(which){
    hideAllModalModes();
    modalDyn = null;
    if(which === "settings"){
      modalTitle.textContent = "è¨­å®š";
      modalDesc.textContent = "è¡¨ç¤ºãƒ»å‡ºåŠ›ã®èª¿æ•´";
      modalModeSettings.style.display = "";
      tplName.value = settings.templateName || "æ—¥æœ¬èªIssueå‹ï¼ˆæ—¢å®šï¼‰";
      afterCopy.value = settings.afterCopy || "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
    }else if(which === "export"){
      modalTitle.textContent = "å‡ºåŠ›ï¼ˆMDï¼‰";
      modalDesc.textContent = "ãã®ã¾ã¾è²¼ã‚Œã‚‹å½¢ã§ã‚³ãƒ”ãƒ¼ã§ãã¾ã™";
      modalModeExport.style.display = "";
    }else if(which === "import"){
      modalTitle.textContent = "èª­è¾¼ï¼ˆMDï¼‰";
      modalDesc.textContent = "è²¼ã‚Šä»˜ã‘ã¦èª­ã¿è¾¼ã¿ã¾ã™";
      modalModeImport.style.display = "";
    }else if(which === "term"){
      modalTitle.textContent = "ç”¨èªã®èª¬æ˜";
      modalDesc.textContent = "çŸ­ã„èª¬æ˜â†’å¿…è¦ãªã‚‰è©³ç´°";
      modalModeTerm.style.display = "";
    }
    overlay.style.display = "flex";
  }

  function closeModal(result){
    overlay.style.display = "none";
    // dyn resolve
    if(modalDyn && typeof modalDyn.resolve === "function"){
      const r = (result === undefined) ? modalDyn.cancelValue : result;
      const resolve = modalDyn.resolve;
      modalDyn = null;
      resolve(r);
    }else{
      modalDyn = null;
    }
  }

  function uiConfirm(message, title="ç¢ºèª", desc=""){
    return new Promise(resolve => {
      hideAllModalModes();
      modalTitle.textContent = title;
      modalDesc.textContent = desc || "ã“ã®æ“ä½œã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ";
      modalModeConfirm.style.display = "";
      confirmMsg.textContent = String(message ?? "");
      modalDyn = { type:"confirm", resolve, cancelValue:false };
      overlay.style.display = "flex";
    });
  }

  function uiPrompt({title="å…¥åŠ›", desc="å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", label="å…¥åŠ›", value="", placeholder="", multiline=false} = {}){
    return new Promise(resolve => {
      hideAllModalModes();
      modalTitle.textContent = title;
      modalDesc.textContent = desc;
      modalModePrompt.style.display = "";
      promptLabel.textContent = label;
      if(multiline){
        promptInput.style.display = "none";
        promptArea.style.display = "";
        promptArea.value = value ?? "";
        promptArea.placeholder = placeholder || "";
        setTimeout(()=>promptArea.focus(),0);
      }else{
        promptArea.style.display = "none";
        promptInput.style.display = "";
        promptInput.value = value ?? "";
        promptInput.placeholder = placeholder || "";
        setTimeout(()=>promptInput.focus(),0);
      }
      modalDyn = { type:"prompt", resolve, cancelValue:null };
      overlay.style.display = "flex";
    });
  }

  // modal events
  btnClose.addEventListener("click", () => {
    if(modalDyn?.type === "confirm") closeModal(false);
    else closeModal(null);
  });

  overlay.addEventListener("click", (e) => {
    if(e.target !== overlay) return;
    if(modalDyn?.type === "confirm") closeModal(false);
    else if(modalDyn?.type === "prompt") closeModal(null);
    else closeModal();
  });

  btnConfirmOk.addEventListener("click", () => closeModal(true));
  btnConfirmCancel.addEventListener("click", () => closeModal(false));

  btnPromptOk.addEventListener("click", () => {
    const v = (promptArea.style.display !== "none") ? promptArea.value : promptInput.value;
    closeModal(String(v ?? ""));
  });
  btnPromptCancel.addEventListener("click", () => closeModal(null));

  // =========================================================
  // LOAD/SAVE
  // =========================================================
  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return deepClone(DEFAULT_STATE);
      const s = JSON.parse(raw);
      if(!s || !Array.isArray(s.projects)) return deepClone(DEFAULT_STATE);
      return s;
    }catch(e){
      return deepClone(DEFAULT_STATE);
    }
  }
  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if(!raw) return { templateName:"æ—¥æœ¬èªIssueå‹ï¼ˆæ—¢å®šï¼‰", afterCopy:"ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", font:"M" };
      const s = JSON.parse(raw);
      return Object.assign({ templateName:"æ—¥æœ¬èªIssueå‹ï¼ˆæ—¢å®šï¼‰", afterCopy:"ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", font:"M" }, s||{});
    }catch(e){
      return { templateName:"æ—¥æœ¬èªIssueå‹ï¼ˆæ—¢å®šï¼‰", afterCopy:"ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", font:"M" };
    }
  }
  function saveSettings(){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }

  // =========================================================
  // HELPERS
  // =========================================================
  function getCurrentProject(){
    return state.projects.find(p => p.id === state.currentProjectId) || state.projects[0];
  }
  function getCurrentRoom(){
    const p = getCurrentProject();
    return p.rooms.find(r => r.id === state.currentRoomId) || p.rooms[0];
  }
  function setCurrentRoom(roomId){
    state.currentRoomId = roomId;
    saveState();
    renderAll();
  }

  function uid(prefix="id"){
    return `${prefix}_${Math.random().toString(36).slice(2,10)}_${Date.now().toString(36)}`;
  }

  // =========================================================
  // RENDER
  // =========================================================
  function renderAll(){
    renderProjects();
    renderRooms();
    renderCards();
    applyFontSetting();
  }

  function renderProjects(){
    const pcur = state.currentProjectId;
    projectTabs.innerHTML = "";
    state.projects.forEach(p => {
      const el = document.createElement("div");
      el.className = "tab" + (p.id===pcur ? " active" : "");
      el.textContent = p.name;
      el.addEventListener("click", () => {
        state.currentProjectId = p.id;
        state.currentRoomId = p.rooms[0]?.id || null;
        saveState();
        renderAll();
      });
      projectTabs.appendChild(el);
    });
  }

  function renderRooms(){
    const p = getCurrentProject();
    const rcur = state.currentRoomId;
    roomTabs.innerHTML = "";
    p.rooms.forEach(r => {
      const el = document.createElement("div");
      el.className = "tab" + (r.id===rcur ? " active" : "");
      el.textContent = r.name;
      el.addEventListener("click", () => setCurrentRoom(r.id));
      roomTabs.appendChild(el);
    });

    ctxPill.textContent = `P: ${p.name} / R: ${getCurrentRoom().name}`;
    ctxSub.textContent = `ã‚«ãƒ¼ãƒ‰æ•°ï¼š${getCurrentRoom().cards.length}ã€€ï½œã€€æœ€çµ‚æ›´æ–°ï¼š${settings.lastTouched || "â€”"}`;
  }

  function renderCards(){
    const room = getCurrentRoom();
    cardList.innerHTML = "";
    if(room.cards.length === 0){
      const empty = document.createElement("div");
      empty.className = "item";
      empty.innerHTML = `
        <div class="itemTop">
          <div class="itemTitle">ã¾ã ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>
          <div class="tag">ã¯ã˜ã‚ã‚‹</div>
        </div>
        <div class="itemText">å³ä¸Šã®ã€Œï¼‹ è¿½åŠ ã€ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚‹ã‹ã€ã€Œè³ªå•ã—ã¦ã€æŒ‡ç¤ºæ›¸ã€ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</div>
      `;
      cardList.appendChild(empty);
      return;
    }

    room.cards.forEach((c, idx) => {
      const it = document.createElement("div");
      it.className = "item";
      it.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemTitle">${escapeHtml(c.label || `ã‚«ãƒ¼ãƒ‰${idx+1}`)}</div>
            <div class="itemText">${escapeHtml(c.text || "")}</div>
          </div>
          <div class="row">
            <span class="tag">${escapeHtml(c.kind || "note")}</span>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <span class="ibtn" data-act="edit">ç·¨é›†</span>
          <span class="ibtn" data-act="del">å‰Šé™¤</span>
        </div>
      `;
      it.querySelector('[data-act="edit"]').addEventListener("click", async () => {
        await editCard(idx);
      });
      it.querySelector('[data-act="del"]').addEventListener("click", async () => {
        await deleteCard(idx);
      });
      cardList.appendChild(it);
    });
  }

  function applyFontSetting(){
    const f = settings.font || "M";
    const scale = (f==="S") ? 0.95 : (f==="L" ? 1.08 : 1.0);
    document.documentElement.style.fontSize = `${16*scale}px`;
  }

  // =========================================================
  // CARD OPS (NO prompt/confirm)
  // =========================================================
  async function addCard({label="", text="", kind="note"} = {}){
    const room = getCurrentRoom();
    room.cards.push({ id: uid("c"), label, text, kind, at: nowIso() });
    settings.lastTouched = nowIso();
    saveSettings();
    saveState();
    renderCards();
  }

  async function editCard(idx){
    const room = getCurrentRoom();
    const c = room.cards[idx];
    if(!c) return;

    const newLabel = await uiPrompt({
      title:"ã‚«ãƒ¼ãƒ‰ç·¨é›†",
      desc:"ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šStep 1 / ä»•æ§˜ / ç¦æ­¢äº‹é …ï¼‰",
      label:"ãƒ©ãƒ™ãƒ«",
      value: c.label || ""
    });
    if(newLabel === null) return;

    const newText = await uiPrompt({
      title:"ã‚«ãƒ¼ãƒ‰ç·¨é›†",
      desc:"æœ¬æ–‡ã‚’å…¥åŠ›ï¼ˆè¤‡æ•°è¡ŒOKï¼‰",
      label:"æœ¬æ–‡",
      value: c.text || "",
      multiline:true,
      placeholder:"ä¾‹ï¼š\n- UIã¯ä¸€åˆ‡è§¦ã‚‰ãšå†…éƒ¨ã ã‘ç›´ã™\n- å˜ä¸€HTMLã§ç´å“ã™ã‚‹\n..."
    });
    if(newText === null) return;

    c.label = newLabel.trim();
    c.text = newText;
    c.at = nowIso();
    settings.lastTouched = nowIso();
    saveSettings();
    saveState();
    renderCards();
    toast("æ›´æ–°ã—ã¾ã—ãŸ");
  }

  async function deleteCard(idx){
    const room = getCurrentRoom();
    const c = room.cards[idx];
    if(!c) return;
    const ok = await uiConfirm(`ã€Œ${c.label || "ã‚«ãƒ¼ãƒ‰"}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`, "å‰Šé™¤ç¢ºèª", "å…ƒã«ã¯æˆ»ã›ã¾ã›ã‚“");
    if(!ok) return;
    room.cards.splice(idx,1);
    settings.lastTouched = nowIso();
    saveSettings();
    saveState();
    renderCards();
    toast("å‰Šé™¤ã—ã¾ã—ãŸ");
  }

  // =========================================================
  // EXPORT / IMPORT (NO confirm)
  // =========================================================
  function buildMarkdown(){
    const p = getCurrentProject();
    const r = getCurrentRoom();
    const lines = [];
    lines.push(`# Anchor æŒ‡ç¤ºæ›¸`);
    lines.push(`- VERSION: ${APP_VERSION}`);
    lines.push(`- BUILD: ${BUILD_ID}`);
    lines.push(`- PROJECT: ${p.name}`);
    lines.push(`- ROOM: ${r.name}`);
    lines.push(`- UPDATED: ${settings.lastTouched || nowIso()}`);
    lines.push("");
    lines.push(`## æŒ‡ç¤ºã‚«ãƒ¼ãƒ‰`);
    r.cards.forEach((c,i) => {
      lines.push(`### ${c.label || `ã‚«ãƒ¼ãƒ‰${i+1}`} ã€”${c.kind || "note"}ã€•`);
      lines.push(c.text || "");
      lines.push("");
    });
    lines.push("---");
    lines.push("ï¼ˆã“ã®MDã¯AnchorãŒç”Ÿæˆï¼‰");
    return lines.join("\n");
  }

  async function doImportMarkdown(md){
    const ok = await uiConfirm("ç¾åœ¨ã®ã‚«ãƒ¼ãƒ‰ã‚’ä¸Šæ›¸ãã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚", "èª­è¾¼ç¢ºèª", "ä¸Šæ›¸ãã•ã‚Œã¾ã™ï¼ˆå–ã‚Šæ¶ˆã—ä¸å¯ï¼‰");
    if(!ok) return false;

    // è¶…ç°¡æ˜“ãƒ‘ãƒ¼ã‚µï¼š### ã‚’ã‚«ãƒ¼ãƒ‰ã¨ã—ã¦å–ã‚Šè¾¼ã‚€
    const room = getCurrentRoom();
    const lines = String(md||"").split(/\r?\n/);
    const cards = [];
    let cur = null;

    for(const line of lines){
      const m = line.match(/^###\s+(.*?)(?:\s+ã€”(.*?)ã€•)?\s*$/);
      if(m){
        if(cur) cards.push(cur);
        cur = { id: uid("c"), label: m[1].trim(), kind: (m[2]||"note").trim(), text:"", at: nowIso() };
      }else{
        if(cur){
          cur.text += (cur.text ? "\n" : "") + line;
        }
      }
    }
    if(cur) cards.push(cur);

    if(cards.length === 0){
      toast("ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", 2200);
      return false;
    }

    room.cards = cards.map(c => ({
      id: c.id, label:c.label, kind:c.kind || "note", text:(c.text||"").trim(), at:c.at
    }));

    settings.lastTouched = nowIso();
    saveSettings();
    saveState();
    renderCards();
    toast(`èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼ˆ${room.cards.length}ä»¶ï¼‰`, 2200);
    return true;
  }

  // =========================================================
  // ASK FLOW (NO prompt)
  // =========================================================
  async function openAskFlow(){
    const q = await uiPrompt({
      title:"è³ªå•ã—ã¦ã€æŒ‡ç¤ºæ›¸ã€ã‚’ä½œã‚‹",
      desc:"ã„ã¾å›°ã£ã¦ã„ã‚‹ã“ã¨ã‚’ã€ãã®ã¾ã¾æ›¸ã„ã¦OKã§ã™ï¼ˆè¤‡æ•°è¡ŒOKï¼‰",
      label:"è³ªå•",
      multiline:true,
      placeholder:"ä¾‹ï¼š\n- GitHub Actions ã®ã©ã“ã‚’æŠ¼ã›ã°ã„ã„ï¼Ÿ\n- Firebase Hosting ã®URLã‚’ä¸€ã¤ã«ã—ãŸã„\n- UIã¯è§¦ã‚‰ãšã€å†…éƒ¨ã ã‘ç›´ã—ãŸã„\n"
    });
    if(q === null) return;

    const qtrim = q.trim();
    if(!qtrim){
      toast("ç©ºã®ã¾ã¾ã§ã¯ä½œã‚Œã¾ã›ã‚“", 2200);
      return;
    }

    // ã“ã“ã¯æš«å®šï¼šã‚«ãƒ¼ãƒ‰åŒ–ï¼ˆå°†æ¥ã“ã“ãŒAIæ¥ç¶šç‚¹ï¼‰
    await addCard({ label:"è³ªå•", kind:"ask", text:qtrim });
    await addCard({ label:"ç›®çš„", kind:"goal", text:"ï¼ˆã“ã“ã«ç›®çš„ã‚’1è¡Œã§ï¼‰" });
    await addCard({ label:"åˆ¶ç´„", kind:"rule", text:"- UIã¯ä¸€åˆ‡è§¦ã‚‰ãšå†…éƒ¨ã ã‘ç›´ã™\n- å˜ä¸€HTMLã§ç´å“" });
    toast("ã‚«ãƒ¼ãƒ‰ã‚’ä½œã‚Šã¾ã—ãŸï¼ˆAIæ¥ç¶šã¯æ¬¡ã®æ®µéšã§ï¼‰", 2400);
  }

  // =========================================================
  // TERM HELP (NO confirm)
  // =========================================================
  const TERM_DB = {
    "hosting": {
      brief: "å…¬é–‹ã—ã¦URLã§è¦‹ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ä»•çµ„ã¿ï¼ˆç½®ãå ´æ‰€ï¼‹é…ä¿¡ï¼‰ã€‚",
      detail: "ä¾‹ï¼šGitHub Pages / Firebase Hosting ãªã©ã€‚ã€ã‚¢ãƒƒãƒ—ã™ã‚‹ã€ã¯ã“ã®å…¬é–‹å…ˆã¸ç½®ãæ„å‘³ã€‚"
    },
    "actions": {
      brief: "GitHubã®è‡ªå‹•å®Ÿè¡Œï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã•ãªãã¦ã‚‚å‹•ãä½œæ¥­ï¼‰ã€‚",
      detail: "ä¾‹ï¼špushï¼ˆä¿å­˜ï¼‰ã—ãŸã‚‰ãƒ“ãƒ«ãƒ‰â†’å…¬é–‹ã€ãªã©ã‚’è‡ªå‹•ã§ã‚„ã£ã¦ãã‚Œã‚‹ã€‚"
    },
    "build": {
      brief: "åŒã˜ã‚³ãƒ¼ãƒ‰ã§ã‚‚â€œç•ªå·ä»˜ãâ€ã§é…å¸ƒã™ã‚‹ãŸã‚ã®å°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾ç­–ï¼‰ã€‚",
      detail: "URLã« ?b=... ã‚’ä»˜ã‘ã‚‹ã¨ã€ç«¯æœ«ãŒå¤ã„è¡¨ç¤ºã‚’æ´ã¿ã«ãããªã‚‹ã€‚"
    }
  };

  async function showTermExplain(term){
    const key = String(term||"").toLowerCase();
    const hit = TERM_DB[key];
    if(!hit){
      toast("ç”¨èªDBã«ã‚ã‚Šã¾ã›ã‚“ï¼ˆä»Šå¾Œè¿½åŠ ã—ã¾ã™ï¼‰", 2200);
      return;
    }
    const ok = await uiConfirm(`${term}\n\n${hit.brief}\n\nè©³ç´°ã‚‚è¦‹ã¾ã™ã‹ï¼Ÿ`, "ç”¨èªã®èª¬æ˜", "ï¼ˆOKã§è©³ç´°ï¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§é–‰ã˜ã‚‹ï¼‰");
    if(!ok) return;
    termBrief.textContent = hit.brief;
    termDetail.textContent = hit.detail;
    openModal("term");
  }

  document.addEventListener("selectionchange", () => {
    const sel = document.getSelection();
    const t = (sel && sel.toString()) ? sel.toString().trim() : "";
    if(!t) return;
    if(t.length > 24) return;

    const t2 = t.toLowerCase();
    if(TERM_DB[t2]){
      // ã“ã“ã¯ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼ˆéåŒæœŸï¼‰
      void showTermExplain(t2);
      try{ sel.removeAllRanges(); }catch(e){}
    }
  });

  // =========================================================
  // EVENTS
  // =========================================================
  btnSettings.addEventListener("click", () => openModal("settings"));
  btnExport.addEventListener("click", () => {
    exportArea.value = buildMarkdown();
    openModal("export");
  });
  btnImport.addEventListener("click", () => openModal("import"));

  btnCopyExport.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(exportArea.value);
      toast(settings.afterCopy || "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }catch(e){
      toast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç«¯æœ«ã®åˆ¶é™ï¼‰", 2400);
    }
  });

  btnDoImport.addEventListener("click", async () => {
    const md = importArea.value || "";
    if(!md.trim()){
      toast("MDãŒç©ºã§ã™", 2200);
      return;
    }
    await doImportMarkdown(md);
  });

  btnSaveSettings.addEventListener("click", () => {
    settings.templateName = (tplName.value || "").trim() || "æ—¥æœ¬èªIssueå‹ï¼ˆæ—¢å®šï¼‰";
    settings.afterCopy = (afterCopy.value || "").trim() || "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
    saveSettings();
    applyFontSetting();
    toast("ä¿å­˜ã—ã¾ã—ãŸ");
  });

  $$('#modalModeSettings [data-font]').forEach(b => {
    b.addEventListener("click", () => {
      settings.font = b.getAttribute("data-font") || "M";
      saveSettings();
      applyFontSetting();
      toast("åæ˜ ã—ã¾ã—ãŸ");
    });
  });

  btnClose.addEventListener("keydown", (e) => {
    if(e.key === "Enter" || e.key === " "){ e.preventDefault(); btnClose.click(); }
  });

  btnAdd.addEventListener("click", async () => {
    const label = await uiPrompt({
      title:"æŒ‡ç¤ºã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ",
      desc:"ã‚«ãƒ¼ãƒ‰ã®è¦‹å‡ºã—ï¼ˆçŸ­ãï¼‰ã‚’å…¥ã‚Œã¦ãã ã•ã„",
      label:"ãƒ©ãƒ™ãƒ«",
      placeholder:"ä¾‹ï¼šStep 1 / ç›®çš„ / ç¦æ­¢äº‹é …"
    });
    if(label === null) return;
    if(!label.trim()){
      toast("ãƒ©ãƒ™ãƒ«ã¯ç©ºã«ã§ãã¾ã›ã‚“", 2200);
      return;
    }

    const text = await uiPrompt({
      title:"æŒ‡ç¤ºã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ",
      desc:"æœ¬æ–‡ï¼ˆè¤‡æ•°è¡ŒOKï¼‰",
      label:"æœ¬æ–‡",
      multiline:true,
      placeholder:"ä¾‹ï¼š\n- ã©ã“ï¼ˆç”»é¢ï¼‰\n- ã©ã‚Œï¼ˆå¯¾è±¡ï¼‰\n- åå‰ï¼ˆæ­£å¼åç§°/ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰\n- ã©ã“ã¸ï¼ˆä¿å­˜/è²¼ä»˜ï¼‰"
    });
    if(text === null) return;

    await addCard({ label: label.trim(), text: text, kind:"note" });
    toast("è¿½åŠ ã—ã¾ã—ãŸ");
  });

  btnCopyAll.addEventListener("click", async () => {
    const md = buildMarkdown();
    try{
      await navigator.clipboard.writeText(md);
      toast(settings.afterCopy || "ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }catch(e){
      toast("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç«¯æœ«ã®åˆ¶é™ï¼‰", 2400);
    }
  });

  btnReset.addEventListener("click", async () => {
    const ok = await uiConfirm("ã“ã®ãƒ«ãƒ¼ãƒ ã®ã‚«ãƒ¼ãƒ‰ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã€‚", "ãƒªã‚»ãƒƒãƒˆç¢ºèª", "å…ƒã«ã¯æˆ»ã›ã¾ã›ã‚“");
    if(!ok) return;
    const room = getCurrentRoom();
    room.cards = [];
    settings.lastTouched = nowIso();
    saveSettings();
    saveState();
    renderCards();
    toast("ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
  });

  btnAskFlow.addEventListener("click", async () => {
    await openAskFlow();
  });

  btnQuickHelp.addEventListener("click", async () => {
    const msg =
`Anchorã¯ã€Œè¿·ã‚ãªã„æŒ‡ç¤ºæ›¸ã€ã‚’ä½œã‚‹é“å…·ã§ã™ã€‚

â‘  å³ä¸Šã€Œï¼‹ è¿½åŠ ã€ã§ã‚«ãƒ¼ãƒ‰ã‚’è¶³ã™
â‘¡ å³ä¸Šã€Œå‡ºåŠ›ï¼ˆMDï¼‰ã€ã§ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼
â‘¢ ã€Œèª­è¾¼ï¼ˆMDï¼‰ã€ã§åˆ¥ç«¯æœ«ã®æŒ‡ç¤ºæ›¸ã‚’å¾©å…ƒ

â€» confirm/prompt/alert ã¯ä½¿ã„ã¾ã›ã‚“ï¼ˆå…¨éƒ¨ã‚¢ãƒ—ãƒªå†…ï¼‰ã€‚`;
    // ã„ã‚ã‚†ã‚‹alertä»£æ›¿ï¼šç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã§OKã ã‘å‡ºã™
    await uiConfirm(msg, "ä½¿ã„æ–¹", "ï¼ˆOKã§é–‰ã˜ã‚‹ï¼‰");
  });

  btnNewProject.addEventListener("click", async () => {
    const name = await uiPrompt({ title:"æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ", desc:"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›", label:"åå‰", placeholder:"ä¾‹ï¼šæå‡ºãã‚“ / Smart Price / NOTE LINK" });
    if(name === null) return;
    const n = name.trim();
    if(!n){ toast("ç©ºã¯ä½œã‚Œã¾ã›ã‚“", 2200); return; }

    const pid = uid("p");
    const rid = uid("r");
    state.projects.push({ id:pid, name:n, rooms:[{ id:rid, name:"ãƒ¡ã‚¤ãƒ³", cards:[] }]});
    state.currentProjectId = pid;
    state.currentRoomId = rid;
    saveState();
    renderAll();
    toast("ä½œã‚Šã¾ã—ãŸ");
  });

  btnNewRoom.addEventListener("click", async () => {
    const name = await uiPrompt({ title:"æ–°è¦ãƒ«ãƒ¼ãƒ ", desc:"ãƒ«ãƒ¼ãƒ åã‚’å…¥åŠ›", label:"åå‰", placeholder:"ä¾‹ï¼šä»•æ§˜ / ãƒã‚°å¯¾å¿œ / ãƒ‡ãƒ—ãƒ­ã‚¤" });
    if(name === null) return;
    const n = name.trim();
    if(!n){ toast("ç©ºã¯ä½œã‚Œã¾ã›ã‚“", 2200); return; }

    const p = getCurrentProject();
    const rid = uid("r");
    p.rooms.push({ id:rid, name:n, cards:[] });
    state.currentRoomId = rid;
    saveState();
    renderAll();
    toast("ä½œã‚Šã¾ã—ãŸ");
  });

  btnRoomRename.addEventListener("click", async () => {
    const p = getCurrentProject();
    const r = getCurrentRoom();
    const name = await uiPrompt({ title:"ãƒ«ãƒ¼ãƒ åç§°å¤‰æ›´", desc:"æ–°ã—ã„åå‰ã‚’å…¥åŠ›", label:"åå‰", value:r.name });
    if(name === null) return;
    const n = name.trim();
    if(!n){ toast("ç©ºã¯ä¸å¯ã§ã™", 2200); return; }
    r.name = n;
    saveState();
    renderAll();
    toast("å¤‰æ›´ã—ã¾ã—ãŸ");
  });

  btnRoomDelete.addEventListener("click", async () => {
    const p = getCurrentProject();
    if(p.rooms.length <= 1){
      toast("æœ€å¾Œã®ãƒ«ãƒ¼ãƒ ã¯å‰Šé™¤ã§ãã¾ã›ã‚“", 2400);
      return;
    }
    const r = getCurrentRoom();
    const ok = await uiConfirm(`ã€Œ${r.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚`, "ãƒ«ãƒ¼ãƒ å‰Šé™¤", "å…ƒã«ã¯æˆ»ã›ã¾ã›ã‚“");
    if(!ok) return;

    p.rooms = p.rooms.filter(x => x.id !== r.id);
    state.currentRoomId = p.rooms[0].id;
    saveState();
    renderAll();
    toast("å‰Šé™¤ã—ã¾ã—ãŸ");
  });

  // =========================================================
  // INIT
  // =========================================================
  renderAll();
  toast(`èµ·å‹•: ${APP_VERSION} / ${BUILD_ID}`, 1800);

})();
</script>
</body>
</html>
